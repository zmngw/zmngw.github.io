<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>.Net 并发编程（最佳实践） &mdash; 码农感悟</title><link rel="stylesheet" href="https://se.zhoubin.online/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://se.zhoubin.online/assets/css/components/collection.css"><link rel="stylesheet" href="https://se.zhoubin.online/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://se.zhoubin.online/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://se.zhoubin.online/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://se.zhoubin.online/assets/css/globals/common.css"><link rel="stylesheet" href="https://se.zhoubin.online/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://se.zhoubin.online/assets/css/posts/index.css"><link rel="stylesheet" href="https://se.zhoubin.online/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://mazhuang.org/rouge-themes/dist/github.css"><link rel="canonical" href="https://se.zhoubin.online/2023/09/09/.Net%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/"><link rel="alternate" type="application/atom+xml" title="码农感悟" href="https://se.zhoubin.online/feed.xml"><link rel="shortcut icon" href="https://se.zhoubin.online/favicon.ico"><meta property="og:title" content=".Net 并发编程（最佳实践）"><meta name="keywords" content="多线程, Net,异步"><meta name="og:keywords" content="多线程, Net,异步"><meta name="description" content="本文接上篇 .Net 并发编程 ，本篇提供并发编程中最佳实践内容及其一些常用代码。"><meta name="og:description" content="本文接上篇 .Net 并发编程 ，本篇提供并发编程中最佳实践内容及其一些常用代码。"><meta property="og:url" content="https://se.zhoubin.online/2023/09/09/.Net%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/"><meta property="og:site_name" content="码农感悟"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2023-09-09"> <script src="https://se.zhoubin.online/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://se.zhoubin.online/assets/js/main.js"></script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://se.zhoubin.online/" title="码农感悟"><span class="octicon octicon-mark-github"></span> 码农感悟</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://se.zhoubin.online/" class="site-header-nav-item" target="" title="首页">首页</a> <a href="https://se.zhoubin.online/categories/" class="site-header-nav-item" target="" title="分类">分类</a> <a href="https://se.zhoubin.online/archives/" class="mobile-hidden site-header-nav-item" target="" title="归档">归档</a> <a href="https://se.zhoubin.online/open-source/" class="mobile-hidden site-header-nav-item" target="" title="开源">开源</a> <a href="https://se.zhoubin.online/fragments/" class="site-header-nav-item" target="" title="片段">片段</a> <a href="https://se.zhoubin.online/wiki/" class="site-header-nav-item" target="" title="维基">维基</a> <a href="https://se.zhoubin.online/links/" class="mobile-hidden site-header-nav-item" target="" title="链接">链接</a> <a href="https://se.zhoubin.online/about/" class="site-header-nav-item" target="" title="关于">关于</a> <a class="mobile-hidden" href="https://se.zhoubin.online/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></nav></div></header><section class="collection-head small geopattern" data-pattern-id=".Net 并发编程（最佳实践）"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">.Net 并发编程（最佳实践）</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2023/09/09 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://se.zhoubin.online/categories/#多线程" title="多线程">多线程</a> </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://se.zhoubin.online/categories/#Net" title="Net">Net</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 13092 字，约 38 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"> <img style="height:72px;width:72px" src="https://se.zhoubin.online/assets/images/qrcode.jpg" alt="码农感悟" /></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><p>本文接上篇 <a href="/2023/09/09/.Net并发编程/">.Net 并发编程</a> ，本篇提供并发编程中最佳实践内容及其一些常用代码。</p><h3 id="五最佳实践">五、最佳实践</h3><h5 id="1静态对象">1、静态对象</h5><ul><li>静态数据和构造函数，静态构造函数执行时，会阻塞线程执行，此过程是线程安全的初始化静态数据</li><li>关键字lock，可以锁定一个代码块线程安全</li><li>ThreadStatic特性，此特性可用于静态字段，每个线程都会有不同的变量，但在线程池中应用时，要注意退出或进入时，对此值进行初始化</li><li>单例，双重检测锁定实现，静态构造函数</li></ul><h5 id="2线程数据限制">2、线程数据限制</h5><p><code class="language-plaintext highlighter-rouge">Parallel.ForEach</code>可以通过提供<code class="language-plaintext highlighter-rouge">ParallelOptions</code>参数用于限制线程数据使用，如：</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">void</span> <span class="nf">ProcessParallelForEachWithLimits</span>
    <span class="p">(</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">items</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">max</span> <span class="p">=</span> <span class="n">Environment</span><span class="p">.</span><span class="n">ProcessorCount</span> <span class="p">&gt;</span> <span class="m">1</span> <span class="p">?</span> 
                <span class="n">Environment</span><span class="p">.</span><span class="n">ProcessorCount</span> <span class="p">/</span> <span class="m">2</span> <span class="p">:</span> <span class="m">1</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">options</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ParallelOptions</span>
    <span class="p">{</span>
        <span class="n">MaxDegreeOfParallelism</span> <span class="p">=</span> <span class="n">max</span> <span class="c1">//线程数</span>
    <span class="p">};</span>
    <span class="n">Parallel</span><span class="p">.</span><span class="nf">ForEach</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">y</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="c1">// Process items</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div><p>PLINQ限制线程数</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="kt">bool</span> <span class="nf">ProcessPlinqWithLimits</span><span class="p">(</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">items</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">max</span> <span class="p">=</span> <span class="n">Environment</span><span class="p">.</span><span class="n">ProcessorCount</span> <span class="p">&gt;</span> <span class="m">1</span> <span class="p">?</span> 
        <span class="n">Environment</span><span class="p">.</span><span class="n">ProcessorCount</span> <span class="p">/</span> <span class="m">2</span> <span class="p">:</span> <span class="m">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">items</span><span class="p">.</span><span class="nf">AsParallel</span><span class="p">()</span>
        <span class="p">.</span><span class="nf">WithDegreeOfParallelism</span><span class="p">(</span><span class="n">max</span><span class="p">)</span> <span class="c1">//线程数</span>
        <span class="p">.</span><span class="nf">Any</span><span class="p">(</span><span class="n">i</span> <span class="p">=&gt;</span> <span class="nf">CheckString</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div><h5 id="3线程池大小调整">3、线程池大小调整</h5><p><code class="language-plaintext highlighter-rouge">ThreadPool.SetMaxThreads</code>, 可以调整最大工作线程数<code class="language-plaintext highlighter-rouge">workerThreads</code>和异步io线程数据<code class="language-plaintext highlighter-rouge">completionPortThreads</code></p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">void</span> <span class="nf">UpdateThreadPoolMax</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">ThreadPool</span><span class="p">.</span><span class="nf">GetMinThreads</span><span class="p">(</span><span class="k">out</span> <span class="kt">int</span> <span class="n">workerMin</span><span class="p">,</span> <span class="k">out</span> <span class="kt">int</span> 
        <span class="n">completionMin</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">workerMax</span> <span class="p">=</span> <span class="nf">GetProcessingMax</span><span class="p">(</span><span class="n">workerMin</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">completionMax</span> <span class="p">=</span> <span class="nf">GetProcessingMax</span><span class="p">(</span><span class="n">completionMin</span><span class="p">);</span>
    <span class="n">ThreadPool</span><span class="p">.</span><span class="nf">SetMaxThreads</span><span class="p">(</span><span class="n">workerMax</span><span class="p">,</span> <span class="n">completionMax</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">private</span> <span class="kt">int</span> <span class="nf">GetProcessingMax</span><span class="p">(</span><span class="kt">int</span> <span class="n">min</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">min</span> <span class="p">&lt;</span> <span class="n">Environment</span><span class="p">.</span><span class="n">ProcessorCount</span> <span class="p">?</span>
                    <span class="n">Environment</span><span class="p">.</span><span class="n">ProcessorCount</span> <span class="p">*</span> <span class="m">2</span> <span class="p">:</span>
                    <span class="n">min</span> <span class="p">*</span> <span class="m">2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>线程饥饿，太多线程由于阻塞，造成无线程可用，公共建议</p><ul><li>Locks,太多线程急用相同的共享资源，分析代码减少此种场景</li><li>No async/await:Asp.net Core中所有Controller方法都标记为async</li><li>太多线程池线程，太多空闲线程需要处理</li><li>不要使用Thread.Suspend 和 Thread.Resume控制线程的执行顺序，应使用 locking算法和Task.ContinueWith</li></ul><h5 id="4ui响应和线程">4、UI响应和线程</h5><p>后台线程的执行场景</p><ul><li>写日志和分析数据</li><li>监控网络和文件系统资源</li><li>读取数据到应用程序</li></ul><p>不适用场景：</p><ul><li>保存应用状态</li><li>执行数据库事务</li><li>应用数据处理</li></ul><p>后台线程创建方式</p><ul><li>设置线程IsBackground属性为true</li><li>ThreadPool中的线程</li><li>TPL启用的线程</li></ul><p>线程池的使用</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ThreadPool</span><span class="p">.</span><span class="nf">QueueUserWorkItem</span><span class="p">(</span><span class="n">GetCurrentOrders</span><span class="p">);</span>
</code></pre></div></div><p>Task.Run</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="n">someAction</span><span class="p">);</span>
<span class="c1">//等同于</span>
<span class="n">Task</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="nf">StartNew</span><span class="p">(</span><span class="n">someAction</span><span class="p">,</span>
    <span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> 
    <span class="n">TaskCreationOptions</span><span class="p">.</span><span class="n">DenyChildAttach</span><span class="p">,</span> 
    <span class="n">TaskScheduler</span><span class="p">.</span><span class="n">Default</span><span class="p">);</span>
</code></pre></div></div><p>Task.Factory.StartNew</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Task</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Order</span><span class="p">&gt;&gt;</span> <span class="n">currentOrdersTask</span> <span class="p">=</span> 
<span class="n">Task</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="nf">StartNew</span><span class="p">(</span><span class="n">GetCurrentOrders</span><span class="p">,</span> 
    <span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> 
    <span class="n">TaskCreationOptions</span><span class="p">.</span><span class="n">AttachedToParent</span><span class="p">,</span> 
    <span class="n">TaskScheduler</span><span class="p">.</span><span class="n">Default</span><span class="p">);</span>
</code></pre></div></div><p>线程中更新UI</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//wpf</span>
<span class="n">Application</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">Dispatcher</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="k">new</span> <span class="nf">Action</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span> 
    <span class="n">usernameTextBox</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="s">"John Doe"</span><span class="p">;</span>
<span class="p">}));</span>

<span class="c1">//winform</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">UpdateUsername</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">updateAction</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Action</span><span class="p">(()</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="n">usernameTextBox</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="s">"John Doe"</span><span class="p">;</span>
        <span class="p">});</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">InvokeRequired</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="n">updateAction</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="nf">updateAction</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div><h5 id="5异步编程">5、异步编程</h5><ul><li>IO密集，网络和磁盘</li><li>CPU密集，内存和cpu操作</li></ul><p>最佳实践</p><ul><li>在同步方法中应用关键字：async,await;少用Wait和Result</li><li>少用Task.WhenAll,应直接使用await</li><li>不要使用async void,应使用 async Task Task<TResult> ValueTask ValueTask<TResult>.一个特例就是在事件handlers中可以使用async void,.Net 6中main方法可标注为async</TResult></TResult></li><li>不要汇合阻塞代码和异步代码，使用async调用异步代码</li><li>在不使用附加参数时，使用Task.Run代替Task.Factory.StartNew</li><li>长时间运行的异步方法应支持CancellationToken</li><li>共享数据的多线程访问应加入线程同步</li><li>总是在IO和网络访问使用async await</li><li>同步方法和异步方法在命名上要有所有区别，所有异步方法以Async结尾</li><li>async异步方法中，不要使用Thread.Sleep,正确应使用 await task.Delay</li><li>I/O密集适合异步操作，但不适合并发操作：文件、数据库、网络调用,async,await</li><li>CPU密集：如果只有少量并行，可以使用Parallel.Invoke代替Parallel.For、Parallel.ForEach</li></ul><p>Parallel.For</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Parallel</span><span class="p">.</span><span class="nf">For</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">files</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">index</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="n">FileInfo</span> <span class="n">fi</span> <span class="p">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
    <span class="p">...</span>
<span class="p">});</span>

</code></pre></div></div><p>Parallel loops with thread-local variables</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="n">FileData</span> <span class="nf">GetInfoForFilesThreadLocal</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> 
    <span class="n">files</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">results</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FileData</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">fileInfos</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">FileInfo</span><span class="p">&gt;();</span>
    <span class="kt">long</span> <span class="n">totalFileSize</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="n">DateTime</span> <span class="n">lastWriteTime</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">MinValue</span><span class="p">;</span>
    <span class="kt">string</span> <span class="n">lastFileWritten</span> <span class="p">=</span> <span class="s">""</span><span class="p">;</span>
    <span class="kt">object</span> <span class="n">dateLock</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>
    <span class="c1">//subtotal 为thread-local</span>
    <span class="n">Parallel</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="kt">long</span><span class="p">&gt;(</span><span class="m">0</span><span class="p">,</span> <span class="n">files</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="m">0</span><span class="p">,</span>
        <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="n">subtotal</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="n">FileInfo</span> <span class="n">fi</span> <span class="p">=</span> <span class="k">new</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
            <span class="kt">long</span> <span class="n">size</span> <span class="p">=</span> <span class="n">fi</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
            <span class="n">DateTime</span> <span class="n">lastWrite</span> <span class="p">=</span> <span class="n">fi</span><span class="p">.</span><span class="n">LastWriteTimeUtc</span><span class="p">;</span>
            <span class="k">lock</span> <span class="p">(</span><span class="n">dateLock</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">lastWriteTime</span> <span class="p">&lt;</span> <span class="n">lastWrite</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">lastWriteTime</span> <span class="p">=</span> <span class="n">lastWrite</span><span class="p">;</span>
                    <span class="n">lastFileWritten</span> <span class="p">=</span> <span class="n">fi</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">subtotal</span> <span class="p">+=</span> <span class="n">size</span><span class="p">;</span>
            <span class="n">fileInfos</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">fi</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">subtotal</span><span class="p">;</span>
            <span class="p">},</span>
        <span class="p">(</span><span class="n">runningTotal</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">Interlocked</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">ref</span>
        <span class="n">totalFileSize</span><span class="p">,</span> <span class="n">runningTotal</span><span class="p">)</span>
    <span class="p">);</span>
    <span class="n">results</span><span class="p">.</span><span class="n">FileInfoList</span> <span class="p">=</span> <span class="n">fileInfos</span><span class="p">;</span>
    <span class="n">results</span><span class="p">.</span><span class="n">TotalSize</span> <span class="p">=</span> <span class="n">totalFileSize</span><span class="p">;</span>
    <span class="n">results</span><span class="p">.</span><span class="n">LastFileWriteTime</span> <span class="p">=</span> <span class="n">lastWriteTime</span><span class="p">;</span>
    <span class="n">results</span><span class="p">.</span><span class="n">LastWrittenFileName</span> <span class="p">=</span> <span class="n">lastFileWritten</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">results</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div><p>Parallel.ForEach</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">static</span> <span class="n">Bitmap</span> <span class="nf">ConvertJpgToBitmap</span><span class="p">(</span><span class="kt">string</span> <span class="n">fileName</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Bitmap</span> <span class="n">bmp</span><span class="p">;</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">Stream</span> <span class="n">bmpStream</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Open</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">Image</span> <span class="n">image</span> <span class="p">=</span> <span class="n">Image</span><span class="p">.</span><span class="nf">FromStream</span><span class="p">(</span><span class="n">bmpStream</span><span class="p">);</span>
        <span class="n">bmp</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Bitmap</span><span class="p">(</span><span class="n">image</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">bmp</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">public</span> <span class="k">static</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Bitmap</span><span class="p">&gt;</span> <span class="nf">ConvertFilesToBitmaps</span><span class="p">(</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">files</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Bitmap</span><span class="p">&gt;();</span>
    <span class="n">Parallel</span><span class="p">.</span><span class="nf">ForEach</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">file</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">FileInfo</span> <span class="n">fi</span> <span class="p">=</span> <span class="k">new</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
        <span class="kt">string</span> <span class="n">ext</span> <span class="p">=</span> <span class="n">fi</span><span class="p">.</span><span class="n">Extension</span><span class="p">.</span><span class="nf">ToLower</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ext</span> <span class="p">==</span> <span class="s">".jpg"</span> <span class="p">||</span> <span class="n">ext</span> <span class="p">==</span> <span class="s">".jpeg"</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">result</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nf">ConvertJpgToBitmap</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div><p>Parallel.ForEachAsync(.net 6.0)</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Bitmap</span><span class="p">&gt;&gt;</span>
    <span class="nf">ConvertFilesToBitmapsAsync</span><span class="p">(</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">files</span><span class="p">,</span> <span class="n">CancellationTokenSource</span> <span class="n">cts</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ParallelOptions</span> <span class="n">po</span> <span class="p">=</span> <span class="k">new</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">CancellationToken</span> <span class="p">=</span> <span class="n">cts</span><span class="p">.</span><span class="n">Token</span><span class="p">,</span>
        <span class="n">MaxDegreeOfParallelism</span> <span class="p">=</span>
            <span class="n">Environment</span><span class="p">.</span><span class="n">ProcessorCount</span> <span class="p">==</span> <span class="m">1</span> <span class="p">?</span> <span class="m">1</span>
                      <span class="p">:</span> <span class="n">Environment</span><span class="p">.</span><span class="n">ProcessorCount</span> <span class="p">-</span> <span class="m">1</span>
    <span class="p">};</span>
    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Bitmap</span><span class="p">&gt;();</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="k">await</span> <span class="n">Parallel</span><span class="p">.</span><span class="nf">ForEachAsync</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">po</span><span class="p">,</span> <span class="k">async</span>
            <span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">_cts</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="n">FileInfo</span> <span class="n">fi</span> <span class="p">=</span> <span class="k">new</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
            <span class="kt">string</span> <span class="n">ext</span> <span class="p">=</span> <span class="n">fi</span><span class="p">.</span><span class="n">Extension</span><span class="p">.</span><span class="nf">ToLower</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ext</span> <span class="p">==</span> <span class="s">".jpg"</span> <span class="p">||</span> <span class="n">ext</span> <span class="p">==</span> <span class="s">"jpeg"</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">result</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nf">ConvertJpgToBitmap</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>
                <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="m">2000</span><span class="p">,</span> <span class="n">_cts</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">OperationCanceledException</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">MessageBox</span><span class="p">.</span><span class="nf">Show</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">finally</span>
    <span class="p">{</span>
        <span class="n">cts</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>Parallel.ForEachAsync 使用try/catch,以便捕获OperationCanceledException，取消事件处理，同时cts要释放</p><p>Parallel.Invoke 示例一：</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Parallel</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="n">DoFirstAction</span><span class="p">,</span> <span class="n">DoSectionAction</span><span class="p">);</span>
<span class="c1">//等同于:</span>
<span class="n">List</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;</span> <span class="n">taskList</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>
<span class="n">taskList</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="n">DoFirstAction</span><span class="p">));</span>
<span class="n">taskList</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="n">DoSectionAction</span><span class="p">));</span>
<span class="n">Task</span><span class="p">.</span><span class="nf">WaitAll</span><span class="p">(</span><span class="n">taskList</span><span class="p">.</span><span class="nf">ToArray</span><span class="p">());</span>
</code></pre></div></div><p>示例二：</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">Parallel</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="n">DoFirstTask</span><span class="p">,</span> <span class="n">DoSecondTask</span><span class="p">));</span>
<span class="c1">//等同于:    </span>
<span class="n">List</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;</span> <span class="n">taskList</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>
<span class="n">taskList</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="n">DoFirstAction</span><span class="p">));</span>
<span class="n">taskList</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="n">DoSectionAction</span><span class="p">));</span>
<span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">WhenAll</span><span class="p">(</span><span class="n">taskList</span><span class="p">.</span><span class="nf">ToArray</span><span class="p">());</span>
</code></pre></div></div><h6 id="blockingcollection的使用">BlockingCollection的使用</h6><p><code class="language-plaintext highlighter-rouge">BlockingCollection&lt;T&gt;</code>是一种常用的数据集合，实现生产消费者模式。可以作为替换<code class="language-plaintext highlighter-rouge">List&lt;T&gt;</code>，而不用作太多修改。可以使用<code class="language-plaintext highlighter-rouge">Add</code>添加子项，不同的地方是当有其他线程在读写时，<code class="language-plaintext highlighter-rouge">BlockingCollection&lt;T&gt;</code>会阻塞当前线程，如果想有timeout时间，可以使用<code class="language-plaintext highlighter-rouge">TryAdd()</code>,此方法支持取消和超时。移除子项采用<code class="language-plaintext highlighter-rouge">Take() or TryTake()</code>,后者同样可以有取消和超时。</p><p><code class="language-plaintext highlighter-rouge">BlockingCollection&lt;T&gt;</code>默认情况下使用<code class="language-plaintext highlighter-rouge">ConcurrentQueue&lt;T&gt;</code>存储数据。也可以使用任何其它实现了<code class="language-plaintext highlighter-rouge">IProducerConsumerCollection&lt;T&gt;</code>接口的数据类型存储数据，如：</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">itemCollection</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BlockingCollection</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="k">new</span> 
    <span class="n">ConcurrentStack</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(),</span> <span class="m">100</span><span class="p">);</span>
    
<span class="kt">var</span> <span class="n">itemCollection</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BlockingCollection</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="k">new</span> 
    <span class="n">ConcurrentBag</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(),</span> <span class="m">100</span><span class="p">);</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">BlockingCollection&lt;T&gt;</code>可以通过方法<code class="language-plaintext highlighter-rouge">GetConsumingEnumerable()</code>获取一个迭代数据集，但这个迭代数据集中元素是可以进行消费的，迭代到数据集为空时，就完成迭代。</p><p>多个<code class="language-plaintext highlighter-rouge">BlockingCollection&lt;T&gt;</code>读写静态方法</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">AddToAny</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">Concurrent</span><span class="p">.</span><span class="n">BlockingCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;[]</span> <span class="n">collections</span><span class="p">,</span> <span class="n">T</span> <span class="n">item</span><span class="p">);</span>
<span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">AddToAny</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">Concurrent</span><span class="p">.</span><span class="n">BlockingCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;[]</span> <span class="n">collections</span><span class="p">,</span> <span class="n">T</span> <span class="n">item</span><span class="p">,</span> <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">);</span>
<span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">TryAddToAny</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">Concurrent</span><span class="p">.</span><span class="n">BlockingCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;[]</span> <span class="n">collections</span><span class="p">,</span> <span class="n">T</span> <span class="n">item</span><span class="p">,</span> <span class="kt">int</span> <span class="n">millisecondsTimeout</span><span class="p">,</span> <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">);</span>
<span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">TryAddToAny</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">Concurrent</span><span class="p">.</span><span class="n">BlockingCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;[]</span> <span class="n">collections</span><span class="p">,</span> <span class="n">T</span> <span class="n">item</span><span class="p">,</span> <span class="n">TimeSpan</span> <span class="n">timeout</span><span class="p">);</span>
<span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">TryAddToAny</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">Concurrent</span><span class="p">.</span><span class="n">BlockingCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;[]</span> <span class="n">collections</span><span class="p">,</span> <span class="n">T</span> <span class="n">item</span><span class="p">,</span> <span class="kt">int</span> <span class="n">millisecondsTimeout</span><span class="p">);</span>
<span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">TryAddToAny</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">Concurrent</span><span class="p">.</span><span class="n">BlockingCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;[]</span> <span class="n">collections</span><span class="p">,</span> <span class="n">T</span> <span class="n">item</span><span class="p">);</span>
</code></pre></div></div><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">TakeFromAny</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">Concurrent</span><span class="p">.</span><span class="n">BlockingCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;[]</span> <span class="n">collections</span><span class="p">,</span> <span class="k">out</span> <span class="n">T</span><span class="p">?</span> <span class="n">item</span><span class="p">,</span> <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">);</span>
<span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">TakeFromAny</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">Concurrent</span><span class="p">.</span><span class="n">BlockingCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;[]</span> <span class="n">collections</span><span class="p">,</span> <span class="k">out</span> <span class="n">T</span><span class="p">?</span> <span class="n">item</span><span class="p">);</span>
<span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">TryTakeFromAny</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">Concurrent</span><span class="p">.</span><span class="n">BlockingCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;[]</span> <span class="n">collections</span><span class="p">,</span> <span class="k">out</span> <span class="n">T</span><span class="p">?</span> <span class="n">item</span><span class="p">);</span>
<span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">TryTakeFromAny</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">Concurrent</span><span class="p">.</span><span class="n">BlockingCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;[]</span> <span class="n">collections</span><span class="p">,</span> <span class="k">out</span> <span class="n">T</span><span class="p">?</span> <span class="n">item</span><span class="p">,</span> <span class="kt">int</span> <span class="n">millisecondsTimeout</span><span class="p">);</span>
<span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">TryTakeFromAny</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">Concurrent</span><span class="p">.</span><span class="n">BlockingCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;[]</span> <span class="n">collections</span><span class="p">,</span> <span class="k">out</span> <span class="n">T</span><span class="p">?</span> <span class="n">item</span><span class="p">,</span> <span class="kt">int</span> <span class="n">millisecondsTimeout</span><span class="p">,</span> <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">);</span>
<span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">TryTakeFromAny</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">Concurrent</span><span class="p">.</span><span class="n">BlockingCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;[]</span> <span class="n">collections</span><span class="p">,</span> <span class="k">out</span> <span class="n">T</span><span class="p">?</span> <span class="n">item</span><span class="p">,</span> <span class="n">TimeSpan</span> <span class="n">timeout</span><span class="p">);</span>
</code></pre></div></div><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FromToAnyDemo</span>
<span class="p">{</span>
    <span class="c1">// Demonstrates:</span>
    <span class="c1">//      Bounded BlockingCollection&lt;T&gt;</span>
    <span class="c1">//      BlockingCollection&lt;T&gt;.TryAddToAny()</span>
    <span class="c1">//      BlockingCollection&lt;T&gt;.TryTakeFromAny()</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">BC_FromToAny</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">BlockingCollection</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;[]</span> <span class="n">bcs</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BlockingCollection</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;[</span><span class="m">2</span><span class="p">];</span>
        <span class="n">bcs</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BlockingCollection</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(</span><span class="m">5</span><span class="p">);</span> <span class="c1">// collection bounded to 5 items</span>
        <span class="n">bcs</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BlockingCollection</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(</span><span class="m">5</span><span class="p">);</span> <span class="c1">// collection bounded to 5 items</span>

        <span class="c1">// Should be able to add 10 items w/o blocking</span>
        <span class="kt">int</span> <span class="n">numFailures</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">BlockingCollection</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;.</span><span class="nf">TryAddToAny</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">==</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span> <span class="n">numFailures</span><span class="p">++;</span>
        <span class="p">}</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"TryAddToAny: {0} failures (should be 0)"</span><span class="p">,</span> <span class="n">numFailures</span><span class="p">);</span>

        <span class="c1">// Should be able to retrieve 10 items</span>
        <span class="kt">int</span> <span class="n">numItems</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">item</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">BlockingCollection</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;.</span><span class="nf">TryTakeFromAny</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="k">out</span> <span class="n">item</span><span class="p">)</span> <span class="p">!=</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span> <span class="n">numItems</span><span class="p">++;</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"TryTakeFromAny: retrieved {0} items (should be 10)"</span><span class="p">,</span> <span class="n">numItems</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>标记数据集不再接收对象</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">void</span> <span class="nf">CompleteAdding</span> <span class="p">();</span>
</code></pre></div></div><h6 id="using-concurrentbag">Using ConcurrentBag</h6><p><code class="language-plaintext highlighter-rouge">ConcurrentBag&lt;T&gt;</code>是一个无序集合，类型本身提供的所有方法都是线程安全，扩展方法不保证全部线程安全。Bag数据类型允许重复数据，包括null</p><h5 id="6多线程调试">6、多线程调试</h5><ul><li>Threads:显示应用可调试的所有线程，同时可以看到激活断点在那个线程，Debug | Windows | Threads 标记线程，用于过虑线程，冻结线程用于“SuspendThread or ResumeThread ”</li><li><table><tbody><tr><td>Parallel Stacks：Debug</td><td>Windows</td><td>Parallel Stacks</td></tr></tbody></table></li><li><table><tbody><tr><td>Parallel Watch：Debug</td><td>Windows</td><td>Parallel Watch</td></tr></tbody></table></li><li><table><tbody><tr><td>Debug Location:此工具栏，显示进程，线程和堆栈，View</td><td>Toolbars</td><td>Debug Location</td></tr></tbody></table></li><li>Tasks</li><li>Attach to Process</li><li>Remote debugging</li><li>GPU Threads</li></ul><h5 id="7异步执行取消">7、异步执行取消</h5><h6 id="使用canceltoken">使用CancelToken</h6><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">ProcessText</span><span class="p">(</span><span class="kt">object</span><span class="p">?</span> <span class="n">cancelToken</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">token</span> <span class="p">=</span> <span class="n">cancelToken</span> <span class="k">as</span> <span class="n">CancellationToken</span><span class="p">?;</span>
    <span class="kt">string</span> <span class="n">text</span> <span class="p">=</span> <span class="s">""</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">x</span> <span class="p">&lt;</span> <span class="m">75000</span><span class="p">;</span> <span class="n">x</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">token</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">IsCancellationRequested</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Cancellation request
</span>                <span class="n">received</span><span class="p">.</span> <span class="n">String</span> <span class="k">value</span><span class="p">:</span> <span class="p">{</span><span class="n">text</span><span class="p">}</span><span class="s">");
</span>            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">text</span> <span class="p">+=</span> <span class="n">x</span> <span class="p">+</span> <span class="s">" "</span><span class="p">;</span>
        <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">500</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">CancelThread</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">using</span> <span class="nn">CancellationTokenSource</span> <span class="n">tokenSource</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Starting operation."</span><span class="p">);</span>
    <span class="n">ThreadPool</span><span class="p">.</span><span class="nf">QueueUserWorkItem</span><span class="p">(</span><span class="k">new</span>
        <span class="nf">WaitCallback</span><span class="p">(</span><span class="n">ManagedThreadsExample</span>
            <span class="p">.</span><span class="n">ProcessText</span><span class="p">),</span> <span class="n">tokenSource</span><span class="p">.</span><span class="n">Token</span><span class="p">);</span>
    <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">5000</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Requesting cancellation."</span><span class="p">);</span>
    <span class="n">tokenSource</span><span class="p">.</span><span class="nf">Cancel</span><span class="p">();</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Cancellation requested."</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><h6 id="并行取消">并行取消</h6><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">ProcessTextParallel</span><span class="p">(</span><span class="kt">object</span><span class="p">?</span>
    <span class="n">cancelToken</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">token</span> <span class="p">=</span> <span class="n">cancelToken</span> <span class="k">as</span> <span class="n">CancellationToken</span><span class="p">?;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="kt">string</span> <span class="n">text</span> <span class="p">=</span> <span class="s">""</span><span class="p">;</span>
    <span class="n">ParallelOptions</span> <span class="n">options</span> <span class="p">=</span> <span class="k">new</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">CancellationToken</span> <span class="p">=</span> <span class="n">token</span><span class="p">.</span><span class="n">Value</span><span class="p">,</span>
        <span class="n">MaxDegreeOfParallelism</span> <span class="p">=</span>
            <span class="n">Environment</span><span class="p">.</span><span class="n">ProcessorCount</span>
    <span class="p">};</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">Parallel</span><span class="p">.</span><span class="nf">For</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">75000</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="n">text</span> <span class="p">+=</span> <span class="n">x</span> <span class="p">+</span> <span class="s">" "</span><span class="p">;</span>
            <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">500</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">OperationCanceledException</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Text value: </span><span class="p">{</span><span class="n">text</span><span class="p">}</span><span class="s">.
</span>            <span class="p">{</span><span class="n">Environment</span><span class="p">.</span><span class="n">NewLine</span><span class="p">}</span> <span class="n">Exception</span>
                <span class="n">encountered</span><span class="p">:</span> <span class="p">{</span><span class="n">e</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">");
</span>    <span class="p">}</span>
<span class="p">}</span>
<span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">CancelParallelFor</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">using</span> <span class="nn">CancellationTokenSource</span> <span class="n">tokenSource</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Press a key to start, then press 'x' to send cancellation."</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">ReadKey</span><span class="p">();</span>
    <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Console</span><span class="p">.</span><span class="nf">ReadKey</span><span class="p">().</span><span class="n">KeyChar</span> <span class="p">==</span> <span class="sc">'x'</span><span class="p">)</span>
            <span class="n">tokenSource</span><span class="p">.</span><span class="nf">Cancel</span><span class="p">();</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">();</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"press a key"</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="n">ManagedThreadsExample</span><span class="p">.</span><span class="nf">ProcessTextParallel</span>
        <span class="p">(</span><span class="n">tokenSource</span><span class="p">.</span><span class="n">Token</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><h6 id="plinq-query取消">PLINQ query取消</h6><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">ProcessNumsPlinq</span><span class="p">(</span><span class="kt">object</span><span class="p">?</span>
    <span class="n">cancelToken</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span><span class="p">[]</span> <span class="n">input</span> <span class="p">=</span> <span class="n">Enumerable</span><span class="p">.</span><span class="nf">Range</span><span class="p">(</span><span class="m">1</span><span class="p">,</span>
        <span class="m">25000000</span><span class="p">).</span><span class="nf">ToArray</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">token</span> <span class="p">=</span> <span class="n">cancelToken</span> <span class="k">as</span> <span class="n">CancellationToken</span><span class="p">?;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="kt">int</span><span class="p">[]?</span> <span class="n">result</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">result</span> <span class="p">=</span>
            <span class="p">(</span><span class="k">from</span> <span class="k">value</span> <span class="k">in</span> <span class="n">input</span><span class="p">.</span><span class="nf">AsParallel</span><span class="p">()</span>
                <span class="p">.</span><span class="nf">WithCancellation</span><span class="p">(</span><span class="n">token</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span>
                <span class="k">where</span> <span class="k">value</span> <span class="p">%</span> <span class="m">7</span> <span class="p">==</span> <span class="m">0</span>
                <span class="k">orderby</span> <span class="k">value</span>
                <span class="k">select</span> <span class="k">value</span><span class="p">).</span><span class="nf">ToArray</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">OperationCanceledException</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Exception encountered:
</span>            <span class="p">{</span><span class="n">e</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">");
</span>    <span class="p">}</span>
<span class="p">}</span>
<span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">CancelPlinq</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">using</span> <span class="nn">CancellationTokenSource</span> <span class="n">tokenSource</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Press a key to start."</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">ReadKey</span><span class="p">();</span>
    <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Requesting cancel."</span><span class="p">);</span>
        <span class="n">tokenSource</span><span class="p">.</span><span class="nf">Cancel</span><span class="p">();</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Cancel requested."</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="n">ManagedThreadsExample</span><span class="p">.</span><span class="nf">ProcessNumsPlinq</span>
        <span class="p">(</span><span class="n">tokenSource</span><span class="p">.</span><span class="n">Token</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><h5 id="8取消模式">8、取消模式</h5><ul><li>OperationCanceledException</li><li>检查CanceltionToken的IsCancellationRequested</li><li>registering a callback method</li><li>Canceling with wait handles</li></ul><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="k">void</span> <span class="nf">FindSmallXValues</span><span class="p">(</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Point</span><span class="p">&gt;</span> <span class="n">points</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="n">Point</span> <span class="n">point</span> <span class="k">in</span> <span class="n">points</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">point</span><span class="p">.</span><span class="n">X</span> <span class="p">&lt;</span> <span class="m">50</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Point with small X coordinate found.Value: </span><span class="p">{</span><span class="n">point</span><span class="p">.</span><span class="n">X</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">token</span><span class="p">.</span><span class="n">IsCancellationRequested</span><span class="p">)</span> <span class="c1">//Cancellation With Token</span>
                <span class="p">{</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">Thread</span><span class="p">.</span><span class="nf">SpinWait</span><span class="p">(</span><span class="m">5000</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div></div><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">DownloadAudioAsync</span>
    <span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">string</span> <span class="n">url</span> <span class="p">=</span> <span class="s">"https://archive.org/download/lp_the-odyssey_homer-anthony-quayle/disc1/lp_the-odyssey_homer-anthony-quayle_disc1side1.flac"</span><span class="p">;</span>
    <span class="k">using</span> <span class="nn">WebClient</span> <span class="n">webClient</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>
    <span class="n">token</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="n">webClient</span><span class="p">.</span><span class="n">CancelAsync</span><span class="p">);</span> <span class="c1">//注册取消token</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="k">await</span> <span class="n">webClient</span><span class="p">.</span><span class="nf">DownloadFileTaskAsync</span><span class="p">(</span><span class="n">url</span><span class="p">,</span>
            <span class="nf">GetDownloadFileName</span><span class="p">());</span>
    <span class="p">}</span><span class="k">catch</span> <span class="p">(</span><span class="n">WebException</span> <span class="n">we</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">we</span><span class="p">.</span><span class="n">Status</span> <span class="p">==</span> <span class="n">WebExceptionStatus</span>
            <span class="p">.</span><span class="n">RequestCanceled</span><span class="p">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">OperationCanceledException</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">AggregateException</span> <span class="n">ae</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span> <span class="k">in</span> <span class="n">ae</span><span class="p">.</span><span class="n">InnerExceptions</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ex</span> <span class="k">is</span> <span class="n">WebException</span> <span class="n">exWeb</span> <span class="p">&amp;&amp;</span>
                <span class="n">exWeb</span><span class="p">.</span><span class="n">Status</span> <span class="p">==</span> <span class="n">WebExceptionStatus</span>
                    <span class="p">.</span><span class="n">RequestCanceled</span><span class="p">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">OperationCanceled</span>
                    <span class="nf">Exception</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">TaskCanceledException</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">OperationCanceledException</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">CancelWithCallback</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">using</span> <span class="nn">CancellationTokenSource</span> <span class="n">tokenSource</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Starting download"</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">task</span> <span class="p">=</span> <span class="nf">DownloadAudioAsync</span><span class="p">(</span><span class="n">tokenSource</span><span class="p">.</span><span class="n">Token</span><span class="p">);</span>
    <span class="n">tokenSource</span><span class="p">.</span><span class="n">Token</span><span class="p">.</span><span class="n">WaitHandle</span><span class="p">.</span><span class="nf">WaitOne</span>
        <span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">3</span><span class="p">));</span>
    <span class="n">tokenSource</span><span class="p">.</span><span class="nf">Cancel</span><span class="p">();</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="k">await</span> <span class="n">task</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">OperationCanceledException</span> <span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Download canceled.
</span>            <span class="n">Exception</span><span class="p">:</span> <span class="p">{</span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">");
</span>    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">CancelWithMultipleTokens</span>
    <span class="p">(</span><span class="n">CancellationToken</span> <span class="n">parentToken</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">using</span> <span class="nn">CancellationTokenSource</span> <span class="n">tokenSource</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>
    <span class="k">using</span> <span class="nn">CancellationTokenSource</span> <span class="n">combinedSource</span> <span class="p">=</span>  
        <span class="n">CancellationTokenSource</span><span class="p">.</span><span class="n">CreateLinked</span>
           <span class="nf">TokenSource</span><span class="p">(</span><span class="n">parentToken</span><span class="p">,</span> <span class="n">tokenSource</span>
               <span class="p">.</span><span class="n">Token</span><span class="p">);</span>
    <span class="n">PollingExample</span><span class="p">.</span><span class="nf">CancelWithPolling</span><span class="p">(</span><span class="n">combinedSource</span><span class="p">);</span>
    <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">1000</span><span class="p">);</span>
    <span class="n">tokenSource</span><span class="p">.</span><span class="nf">Cancel</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div><h5 id="9异步单元测试">9、异步单元测试</h5><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">Fact</span><span class="p">]</span>
<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="n">GetCustomerOrdersAsync_</span>
    <span class="nf">Throws_Exception_For_Invalid_CustomerId</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">service</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">BookOrderService</span><span class="p">();</span>
    <span class="k">await</span> <span class="n">Assert</span><span class="p">.</span><span class="n">ThrowsAsync</span><span class="p">&lt;</span><span class="n">ArgumentException</span><span class="p">&gt;(</span><span class="k">async</span>
        <span class="p">()</span> <span class="p">=&gt;</span> <span class="k">await</span> <span class="n">service</span><span class="p">.</span><span class="nf">GetCustomerOrdersAsync</span>
            <span class="p">(-</span><span class="m">2</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="https://se.zhoubin.online" target="_blank">zhoubin</a></li><li>本文链接：<a href="https://se.zhoubin.online/2023/09/09/.Net%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" target="_blank">https://se.zhoubin.online/2023/09/09/.Net%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"> <script src="https://giscus.app/client.js" data-repo="usteinfo/blog-comments" data-repo-id="R_kgDOKL8L_A" data-category="Announcements" data-category-id="DIC_kwDOKL8L_M4CY4xg" data-mapping="title" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async> </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://se.zhoubin.online/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://se.zhoubin.online/assets/search_data.json?v=1707630116', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://se.zhoubin.online/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2023 <span title="zhoubin">zhoubin</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/usteinfo/usteinfo.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://se.zhoubin.online/" title="首页" target="">首页</a></li><li> <a href="https://se.zhoubin.online/categories/" title="分类" target="">分类</a></li><li> <a href="https://se.zhoubin.online/archives/" title="归档" target="">归档</a></li><li> <a href="https://se.zhoubin.online/open-source/" title="开源" target="">开源</a></li><li> <a href="https://se.zhoubin.online/fragments/" title="片段" target="">片段</a></li><li> <a href="https://se.zhoubin.online/wiki/" title="维基" target="">维基</a></li><li> <a href="https://se.zhoubin.online/links/" title="链接" target="">链接</a></li><li> <a href="https://se.zhoubin.online/about/" title="关于" target="">关于</a></li><li><a href="https://se.zhoubin.online/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://se.zhoubin.online/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script></body></html>
