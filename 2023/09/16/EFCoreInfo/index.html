<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>EF Core 技巧 &mdash; 码农感悟</title><link rel="stylesheet" href="https://zmngw.github.io/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://zmngw.github.io/assets/css/components/collection.css"><link rel="stylesheet" href="https://zmngw.github.io/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://zmngw.github.io/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://zmngw.github.io/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://zmngw.github.io/assets/css/globals/common.css"><link rel="stylesheet" href="https://zmngw.github.io/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://zmngw.github.io/assets/css/posts/index.css"><link rel="stylesheet" href="https://zmngw.github.io/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://mazhuang.org/rouge-themes/dist/github.css"><link rel="canonical" href="https://zmngw.github.io/2023/09/16/EFCoreInfo/"><link rel="alternate" type="application/atom+xml" title="码农感悟" href="https://zmngw.github.io/feed.xml"><link rel="shortcut icon" href="https://zmngw.github.io/favicon.ico"><meta property="og:title" content="EF Core 技巧"><meta name="keywords" content="ef, c#"><meta name="og:keywords" content="ef, c#"><meta name="description" content="本文描述 EF Core 常用使用技巧,可以作为知识库查询EF的使用方法。"><meta name="og:description" content="本文描述 EF Core 常用使用技巧,可以作为知识库查询EF的使用方法。"><meta property="og:url" content="https://zmngw.github.io/2023/09/16/EFCoreInfo/"><meta property="og:site_name" content="码农感悟"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2023-09-16"> <script src="https://zmngw.github.io/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://zmngw.github.io/assets/js/main.js"></script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://zmngw.github.io/" title="码农感悟"><span class="octicon octicon-mark-github"></span> 码农感悟</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://zmngw.github.io/" class="site-header-nav-item" target="" title="首页">首页</a> <a href="https://zmngw.github.io/categories/" class="site-header-nav-item" target="" title="分类">分类</a> <a href="https://zmngw.github.io/archives/" class="mobile-hidden site-header-nav-item" target="" title="归档">归档</a> <a href="https://zmngw.github.io/open-source/" class="mobile-hidden site-header-nav-item" target="" title="开源">开源</a> <a href="https://zmngw.github.io/fragments/" class="site-header-nav-item" target="" title="片段">片段</a> <a href="https://zmngw.github.io/wiki/" class="site-header-nav-item" target="" title="维基">维基</a> <a href="https://zmngw.github.io/links/" class="mobile-hidden site-header-nav-item" target="" title="链接">链接</a> <a href="https://zmngw.github.io/about/" class="site-header-nav-item" target="" title="关于">关于</a> <a class="mobile-hidden" href="https://zmngw.github.io/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="EF Core 技巧"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">EF Core 技巧</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2023/09/16 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://zmngw.github.io/categories/#ef" title="ef">ef</a> </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://zmngw.github.io/categories/#c#" title="c#">c#</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 12851 字，约 37 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"> <img style="height:72px;width:72px" src="https://zmngw.github.io/assets/images/qrcode.jpg" alt="码农感悟" /></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><p>本文描述 EF Core 常用使用技巧,可以作为知识库查询EF的使用方法。</p><h4 id="输出查询sql语句">输出查询SQL语句</h4><p>在Entity Framework的第一个迭代版本中，没有内置的日志记录。但是有<code class="language-plaintext highlighter-rouge">ObjectQuery.ToTraceString()</code>，这是一种运行时方法，可以动态计算LINQ或Entity SQL查询的SQL，尽管这不是一个很好的日志记录方法，但它毕竟可以输出SQL，即使在今天，也有一些有用的场景。 直到最新版本EF Core 5，该功能才成为EF Core的一部分，并且已重命名为<code class="language-plaintext highlighter-rouge">ToQueryString()</code>。注意在InMemory程序中无效。</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">sqlFromQuery</span><span class="p">=</span><span class="n">context</span><span class="p">.</span><span class="n">People</span><span class="p">.</span><span class="nf">ToQueryString</span><span class="p">();</span>
</code></pre></div></div><h4 id="日志输出">日志输出</h4><p>使用LogTo方法轻松配置DbContext，将.NET日志记录输出。 嗯，我就想看着你，就这样子，简简单单。 EF Core将输出很多事件。分为以下类，这些类从DbCloggerCategory派生。</p><table><thead><tr><th>分类</th><th>名称</th></tr></thead><tbody><tr><td>变更追踪</td><td>ChangeTracking</td></tr><tr><td>数据库命令</td><td>Database.Command</td></tr><tr><td>数据库连接</td><td>Database.Connection</td></tr><tr><td>数据库事务</td><td>Database.Transaction</td></tr><tr><td>数据库</td><td>Database</td></tr><tr><td>基础设施</td><td>Infrastructure</td></tr><tr><td>数据库挖掘</td><td>Migrations</td></tr><tr><td>模型验证</td><td>Model.Validation</td></tr><tr><td>模型</td><td>Model</td></tr><tr><td>查询</td><td>Query</td></tr><tr><td>脚手架</td><td>Scaffolding</td></tr><tr><td>更新</td><td>Update</td></tr></tbody></table><p>LogTo 的一个参数指定目标为控制台窗口、文件或调试窗口。然后，第二个参数允许您通过.NET LogLevel以及您感兴趣的任何DLoggerCategoy进行筛选。</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//DbContext将日志输出到控制台，并过滤掉所有DbLoggerCategory类型LogLevel.Information组。</span>
<span class="n">optionsBuilder</span><span class="p">.</span><span class="nf">UseSqlServer</span><span class="p">(</span><span class="n">myConnectionString</span><span class="p">)</span>
<span class="p">.</span><span class="nf">LogTo</span><span class="p">(</span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">,</span><span class="n">LogLevel</span><span class="p">.</span><span class="n">Information</span><span class="p">);</span>
</code></pre></div></div><p>下面一个LogTo方法添加了第三个参数-DbLoggerCatetory数组（仅包含一个数组），以便仅对EF Core的数据库命令进行进一步过滤。 与LogTo方法一起，我添加了EnableSensitiveDataLogging方法以在SQL中显示传入参数。这将捕获所有发送到数据库的SQL：查询，更新，原始SQL甚至通过迁移发送的更改。</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">.</span><span class="nf">LogTo</span><span class="p">(</span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">,</span> <span class="n">LogLevel</span><span class="p">.</span><span class="n">Information</span><span class="p">,</span>
    <span class="k">new</span><span class="p">[]{</span><span class="n">DbLoggerCategory</span><span class="p">.</span><span class="n">Database</span><span class="p">.</span><span class="n">Command</span><span class="p">.</span><span class="n">Name</span><span class="p">},</span>
<span class="p">)</span>
<span class="p">.</span><span class="nf">EnableSensitiveDataLogging</span><span class="p">();</span>
</code></pre></div></div><p>上面包含IsDeleted属性的“Person”类型也具有FirstName和LastName属性。这是添加新的Person对象后调用SaveChanges的日志。</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">info</span><span class="p">:</span> <span class="m">1</span><span class="p">/</span><span class="m">4</span><span class="p">/</span><span class="m">2021</span> <span class="m">17</span><span class="p">:</span><span class="m">56</span><span class="p">:</span><span class="m">09.935</span>
    <span class="n">RelationalEventId</span><span class="p">.</span><span class="n">CommandExecuted</span><span class="p">[</span><span class="m">20101</span><span class="p">]</span>
    <span class="p">(</span><span class="n">Microsoft</span><span class="p">.</span><span class="n">EntityFrameworkCore</span><span class="p">.</span><span class="n">Database</span><span class="p">.</span><span class="n">Command</span><span class="p">)</span>

<span class="n">Executed</span> <span class="nf">DbCommand</span> <span class="p">(</span><span class="m">22</span><span class="n">ms</span><span class="p">)</span> <span class="p">[</span><span class="n">Parameters</span><span class="p">=[</span> 
    <span class="n">@p0</span><span class="p">=</span><span class="err">'</span><span class="n">Julie</span><span class="err">'</span> <span class="p">(</span><span class="n">Size</span> <span class="p">=</span> <span class="m">4000</span><span class="p">),</span> <span class="n">@p1</span><span class="p">=</span><span class="err">'</span><span class="n">False</span><span class="err">'</span><span class="p">,</span> 
    <span class="n">@p2</span><span class="p">=</span><span class="err">'</span><span class="n">Lerman</span><span class="err">'</span> <span class="p">(</span><span class="n">Size</span> <span class="p">=</span> <span class="m">4000</span><span class="p">)],</span><span class="n">CommandType</span><span class="p">=</span><span class="err">'</span><span class="n">Text</span><span class="err">'</span><span class="p">,</span>
    <span class="n">CommandTimeout</span><span class="p">=</span><span class="err">'</span><span class="m">30</span><span class="err">'</span><span class="p">]</span>

    <span class="n">SET</span> <span class="n">NOCOUNT</span> <span class="n">ON</span><span class="p">;</span>
    <span class="n">INSERT</span> <span class="n">INTO</span> <span class="p">[</span><span class="n">People</span><span class="p">]</span> <span class="p">([</span><span class="n">FirstName</span><span class="p">],[</span><span class="n">IsDeleted</span><span class="p">],</span> <span class="p">[</span><span class="n">LastName</span><span class="p">])</span>
    <span class="nf">VALUES</span> <span class="p">(</span><span class="n">@p0</span><span class="p">,</span> <span class="n">@p1</span><span class="p">,</span> <span class="n">@p2</span><span class="p">);</span>
    <span class="n">SELECT</span> <span class="p">[</span><span class="n">Id</span><span class="p">]</span>
    <span class="n">FROM</span> <span class="p">[</span><span class="n">People</span><span class="p">]</span>
    <span class="n">WHERE</span> <span class="err">@</span><span class="n">@ROWCOUNT</span> <span class="p">=</span> <span class="m">1</span> <span class="n">AND</span> <span class="p">[</span><span class="n">Id</span><span class="p">]</span> <span class="p">=</span> <span class="nf">scope_identity</span><span class="p">();</span>
</code></pre></div></div><blockquote><p>注意顶部的EventId。您甚至可以定义日志记录以使用这些ID过滤特定事件。您还可以过滤出特定的日志类别，并且可以控制格式。在 <a href="https://docs.microsoft.com/zh-cn/ef/core/logging-events-diagnostics/simple-logging">网站</a> 上查看有关这些各种功能的更多详细信息的文档。 简单日志记录是记录EF Core的高级方法，是的，高级的就是简单的，这就是计算机世界的定义！ 您也可以通过直接与Microsoft.Extensions.Logging一起，以对EF Core的日志方式进行更多控制。检查EF Core文档，以获取更多有关使用此更高级用法的 <a href="https://docs.microsoft.com/zh-cn/ef/core/logging-events-diagnostics/extensions-logging">详细信息</a> 。</p></blockquote><h4 id="响应ef-core-事件">响应EF Core 事件</h4><table><thead><tr><th>事件名称</th><th>版本</th><th>说明</th></tr></thead><tbody><tr><td>ChangeTracker.Tracked</td><td>2.1</td><td>在DbContext开始跟踪实体时引发</td></tr><tr><td>ChangeTracker.StateChanged</td><td>2.1</td><td>在已跟踪的实体的状态改变时引发</td></tr><tr><td>DbContext.SavingChanges</td><td>5.0</td><td>当上下文将要保存更改时</td></tr><tr><td>DbContext.SavedChanges</td><td>5.0</td><td>保存成功时引发</td></tr><tr><td>DbContext.SaveChangesFailed</td><td>5.0</td><td>保存失败时引发</td></tr><tr><td>DbContext.SaveChangesAsync</td><td>5.0</td><td>异步保存成功时引发</td></tr></tbody></table><h4 id="事件计数器访问指标">事件计数器访问指标</h4><blockquote><p>EF Core 5利用了.NET Core 3.0中.NET引入的一项很酷的功能-dotnet-counters（https://docs.microsoft.com/zh-cn/dotnet/core/diagnostics/dotnet-counters）。计数器是一个全局命令行工具。您可以使用dotnet CLI安装此工具。</p></blockquote><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dotnet</span> <span class="n">tool</span> <span class="n">install</span> <span class="p">--</span><span class="k">global</span> <span class="n">dotnet</span><span class="p">-</span><span class="n">counters</span>
</code></pre></div></div><p>安装完成后，您可以告诉它监视在dotnet环境中运行的进程。您需要提供正在运行的.NET应用程序的进程ID</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Process</span><span class="p">.</span><span class="nf">GetCurrentProcess</span><span class="p">().</span><span class="n">Id</span>
</code></pre></div></div><p>在Visual Studio中，我无法简单地在调试器中调试此值。调试器只会告诉您“此表达式会产生副作用，因此不会被评估。” 因此，我将其嵌入到我的代码中并获得了值313131。</p><p>在拥有ID且应用仍在运行的情况下，然后可以触发计数器，开始监视来自Microsoft.EntityFramework命名空间的事件。如下：</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dotnet</span> <span class="n">counters</span> <span class="n">monitor</span>    <span class="n">Microsoft</span><span class="p">.</span><span class="n">EntityFrameworkCore</span> <span class="p">-</span><span class="n">p</span> <span class="m">313131</span>
</code></pre></div></div><p>然后，当您遍历应用程序时，计数器将显示EF Core统计信息的特定列表</p><h4 id="拦截ef-core的数据拦截器ef-core-3">拦截EF Core的数据——拦截器(EF Core 3)</h4><p>EF Core的拦截器是一项功能，该功能始于EF6，并在EF Core 3中重新引入。EF Core 5中引入了SaveChanges的新拦截器。 共有三种不同的拦截器类来拦截命令，连接和事务，以及用于SaveChanges的新拦截器类。每个类都有自己相关的虚拟方法（和相关对象）。</p><p>例如，DbCommandInterceptor公开了ReaderExecuting和ReaderExecutingAsync，它们在命令即将发送到数据库时被触发。</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">override</span> <span class="n">InterceptionResult</span><span class="p">&lt;</span><span class="n">DbDataReader</span><span class="p">&gt;</span>
   <span class="nf">ReaderExecuting</span><span class="p">(</span>
       <span class="n">DbCommand</span> <span class="n">command</span><span class="p">,</span>
       <span class="n">CommandEventData</span> <span class="n">eventData</span><span class="p">,</span>
       <span class="n">InterceptionResult</span><span class="p">&lt;</span><span class="n">DbDataReader</span><span class="p">&gt;</span> <span class="n">result</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="c1">//例如，webmote支持你干点啥?</span>
       <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
   <span class="p">}</span>
</code></pre></div></div><p>它的参数之一是DbCommand，其CommandText属性保存SQL。 如果要修改SQL，添加查询提示或其他任务，则可以更改命令，然后使用新CommandText值的命令将继续进行。 从数据库返回任何结果数据时，将触发ReaderExecuted / Async方法。</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">override</span> <span class="n">DbDataReader</span> <span class="nf">ReaderExecuted</span><span class="p">(</span>
    <span class="n">DbCommand</span> <span class="n">command</span><span class="p">,</span>
    <span class="n">CommandExecutedEventData</span> <span class="n">eventData</span><span class="p">,</span>
    <span class="n">DbDataReader</span> <span class="n">result</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">base</span><span class="p">.</span><span class="nf">ReaderExecuted</span>
        <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">eventData</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div><p>例如，在这里您可以捕获DbDataReader，并对该数据进行某些处理，然后再继续执行EF Core实现。</p><h4 id="查询拦截">查询拦截</h4><p>EF Core 公开的 DbCommandInterceptor拦截器提供查询拦截功能，查询拦截是在数据库上执行查询之前插入逻辑，或者在查询执行之后（以及控制返回到调用代码之前）立即插入逻辑的能力。 此功能在现实世界中有多种使用案例： 延长具有某些特征的命令的超时 查询失败并记录异常时诊断信息 当读取到内存的行数超过特定阈值时，记录警告 一个小例子：</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">TestQueryInterceptor</span> <span class="p">:</span> <span class="n">DbCommandInterceptor</span>
<span class="p">{</span>
    <span class="c1">// runs before a query is executed</span>
    <span class="k">public</span> <span class="k">override</span> <span class="n">InterceptionResult</span><span class="p">&lt;</span><span class="n">DbDataReader</span><span class="p">&gt;</span> <span class="nf">ReaderExecuting</span><span class="p">(</span><span class="n">DbCommand</span> <span class="n">command</span><span class="p">,</span> <span class="n">CommandEventData</span> <span class="n">eventData</span><span class="p">,</span> <span class="n">InterceptionResult</span><span class="p">&lt;</span><span class="n">DbDataReader</span><span class="p">&gt;</span> <span class="n">result</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">command</span><span class="p">.</span><span class="n">CommandText</span> <span class="p">+=</span> <span class="s">" OPTION (OPTIMIZE FOR UNKNOWN)"</span><span class="p">;</span>   
        <span class="n">command</span><span class="p">.</span><span class="n">CommandTimeout</span> <span class="p">=</span> <span class="m">12345</span><span class="p">;</span>   
         <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="c1">// runs after a query is excuted</span>
    <span class="k">public</span> <span class="k">override</span> <span class="n">DbDataReader</span> <span class="nf">ReaderExecuted</span><span class="p">(</span><span class="n">DbCommand</span> <span class="n">command</span><span class="p">,</span> <span class="n">CommandExecutedEventData</span> <span class="n">eventData</span><span class="p">,</span> <span class="n">DbDataReader</span> <span class="n">result</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nf">ShouldChangeResult</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="k">out</span> <span class="kt">var</span> <span class="n">changedResult</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">changedResult</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>注意： 大多数方法都有同步和异步版本。令人讨厌的是，异步查询仅触发异步方法（反之亦然），因此在编写拦截器时必须覆盖两者。 安装拦截器是很简单的。</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">SampleDbContext</span> <span class="p">:</span> <span class="n">DbContext</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnConfiguring</span><span class="p">(</span><span class="n">DbContextOptionsBuilder</span> <span class="n">optionsBuilder</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">optionsBuilder</span>
            <span class="p">.</span><span class="nf">UseSqlite</span><span class="p">(</span><span class="s">@"Data Source=Sample.db;"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">AddInterceptors</span><span class="p">(</span><span class="k">new</span> <span class="nf">TestQueryInterceptor</span> <span class="p">(),</span> <span class="k">new</span> <span class="nf">SampleInterceptor2</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>通过返回InterceptionResult<T>.SuppressWithResult()禁止执行。重要的是要注意，DbCommandInterceptor安装的其他所有组件仍将执行，并且可以通过上的HasResult属性检查其他拦截器是否已禁止执行result。</T></p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">override</span> <span class="n">InterceptionResult</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span> <span class="nf">ScalarExecuting</span><span class="p">(</span><span class="n">DbCommand</span> <span class="n">command</span><span class="p">,</span> <span class="n">CommandEventData</span> <span class="n">eventData</span><span class="p">,</span> <span class="n">InterceptionResult</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nf">ShouldSuppressExecution</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">InterceptionResult</span><span class="p">.</span><span class="n">SuppressWithResult</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;(</span><span class="k">null</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>方法中引发的异常从技术上将阻止执行，不要利用这个事实，将异常用于控制流几乎总是很糟糕的设计。 你可以拦截如下清单的操作：</p><table><thead><tr><th>方法</th><th>操作</th></tr></thead><tbody><tr><td>CommandCreating</td><td>在创建命令之前（注意：一切都是命令，因此它将拦截所有查询）</td></tr><tr><td>CommandCreated</td><td>创建命令之后但执行之前</td></tr><tr><td>CommandFailed[Async]</td><td>在执行过程中命令失败并出现异常后</td></tr><tr><td>ReaderExecuting[Async]</td><td>在执行“查询”命令之前</td></tr><tr><td>ReaderExecuted[Async]</td><td>执行“查询”命令后</td></tr><tr><td>NonQueryExecuting[Async]</td><td>在执行“非查询”命令之前（注意：非查询的一个示例是 ExecuteSqlRaw</td></tr><tr><td>NonQueryExecuted[Async]</td><td>执行“非查询”命令后</td></tr><tr><td>ScalarExecuting [Async]</td><td>在执行“标量”命令之前（注意：“标量”是存储过程的同义词）</td></tr><tr><td>ScalarExecuted [Async]</td><td>执行“标量”命令后</td></tr><tr><td>DataReaderDispose</td><td>执行命令后</td></tr></tbody></table><p>这是一个耗时命令拦截</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">MyDBCommandInterceptor</span><span class="p">:</span> <span class="n">DbCommandInterceptor</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">ConcurrentDictionary</span> <span class="n">CommandStartTimes</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ConcurrentDictionary</span><span class="p">();</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">ConcurrentDictionary</span> <span class="n">CommandDurations</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ConcurrentDictionary</span><span class="p">();</span>

    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">NonQueryExecuting</span><span class="p">(</span><span class="n">DbCommand</span> <span class="n">command</span><span class="p">,</span> <span class="n">DbCommandInterceptionContext</span> <span class="n">interceptionContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">CommandStartTimes</span><span class="p">.</span><span class="nf">TryAdd</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">);</span>
        <span class="k">base</span><span class="p">.</span><span class="nf">NonQueryExecuting</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">interceptionContext</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">ReaderExecuting</span><span class="p">(</span><span class="n">DbCommand</span> <span class="n">command</span><span class="p">,</span> <span class="n">DbCommandInterceptionContext</span> <span class="n">interceptionContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">CommandStartTimes</span><span class="p">.</span><span class="nf">TryAdd</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">);</span>
        <span class="k">base</span><span class="p">.</span><span class="nf">ReaderExecuting</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">interceptionContext</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">ScalarExecuting</span><span class="p">(</span><span class="n">DbCommand</span> <span class="n">command</span><span class="p">,</span> <span class="n">DbCommandInterceptionContext</span> <span class="n">interceptionContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">CommandStartTimes</span><span class="p">.</span><span class="nf">TryAdd</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">);</span>
        <span class="k">base</span><span class="p">.</span><span class="nf">ScalarExecuting</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">interceptionContext</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">NonQueryExecuted</span><span class="p">(</span><span class="n">DbCommand</span> <span class="n">command</span><span class="p">,</span> <span class="n">DbCommandInterceptionContext</span> <span class="n">interceptionContext</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">base</span><span class="p">.</span><span class="nf">NonQueryExecuted</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">interceptionContext</span><span class="p">);</span>
    <span class="nf">AccumulateTime</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">ReaderExecuted</span><span class="p">(</span><span class="n">DbCommand</span> <span class="n">command</span><span class="p">,</span> <span class="n">DbCommandInterceptionContext</span> <span class="n">interceptionContext</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">base</span><span class="p">.</span><span class="nf">ReaderExecuted</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">interceptionContext</span><span class="p">);</span>
    <span class="nf">AccumulateTime</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">ScalarExecuted</span><span class="p">(</span><span class="n">DbCommand</span> <span class="n">command</span><span class="p">,</span> <span class="n">DbCommandInterceptionContext</span> <span class="n">interceptionContext</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">base</span><span class="p">.</span><span class="nf">ScalarExecuted</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">interceptionContext</span><span class="p">);</span>
    <span class="nf">AccumulateTime</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">AccumulateTime</span><span class="p">(</span><span class="n">DbCommand</span> <span class="n">command</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">CommandStartTimes</span><span class="p">.</span><span class="nf">TryRemove</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="k">out</span>
    <span class="kt">var</span> <span class="n">commandStartTime</span><span class="p">))</span> <span class="p">{</span>
            <span class="kt">var</span> <span class="n">commandDuration</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span> <span class="p">-</span> <span class="n">commandStartTime</span><span class="p">;</span>
            <span class="n">CommandDurations</span><span class="p">.</span><span class="nf">AddOrUpdate</span><span class="p">(</span><span class="n">command</span><span class="p">.</span><span class="n">CommandText</span><span class="p">,</span> <span class="n">commandDuration</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">accumulated</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">commandDuration</span> <span class="p">+</span> <span class="n">accumulated</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h4 id="ef-core-5中的sleeper功能调试视图">EF Core 5中的Sleeper功能：调试视图</h4><p>ChangeTracker.DebugView和Model.DebugView</p><p>DebugViews输出格式正确的字符串，其中有ChangeTracker的状态或模型中的元数据的信息。DebugView提供了一个漂亮的文档，您可以捕获和打印该文档，并真正了解其幕后情况。</p><p>我在调试器上花费了大量时间，以探索有关变更跟踪器了解的内容或EF Core如何解释我所描述的模型的各种详细信息。能够以这种文本格式读取此信息，甚至将其保存在文件中，因此您无需反复调试即可收集详细信息，这是EF Core 5的一项神奇功能。</p><p>在DbContext.ChangeTracker.DebugView中，您将找到ShortView和LongView属性。</p><p>例如，这里是我刚查询一个Person对象时的视图，而我的上下文仅包含一个人。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Person {Id: 1} Unchanged
</code></pre></div></div><p>这是最常用的信息-在我的上下文中，只有一个未更改的Person的ID为1。 LongView提供了有关被跟踪实体的更多详细信息。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Person {Id: 1} Unchanged
    Id: 1 PK
    FirstName: 'Julie'
    IsDeleted: 'False'
    LastName: 'Lerman'
    UserId: 101
    Addresses: []
</code></pre></div></div><p>如果要在跟踪的Person上对其进行编辑并强制上下文检测更改，则LongView除了将状态显示为Modified之外，还对LastName属性所做的更改进行记录。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Person {Id: 1} Modified
   Id: 1 PK
   FirstName: 'Julie'
   IsDeleted: 'False'
   LastName: 'Lermantov' Modified
   Originally 'Lerman'
   UserId: 101
   Addresses: []
</code></pre></div></div><p>您可以在此视图中看到一个Addresses属性。实际上，使用导航，“人”和“地址”之间存在多对多关系。EF Core在运行时推断内存中的PersonAddress实体，以便将关系数据持久化到联接表中。 当我在其“地址”集合中创建一个具有一个地址的人的图形时，您可以在ShortView中看到一个“人”，一个地址和一个推断的PersonAddress对象。长视图显示了这些对象的属性。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AddressPerson (Dictionary&lt;string, object&gt;)
    {AddressesId: 1, ResidentsId: 1} Unchanged FK
    {AddressesId: 1} FK {ResidentsId: 1}
Address {Id: 1} Unchanged
Person {Id: 1} Modified
</code></pre></div></div><p>我喜欢这些调试视图，这些视图可以在调试时帮助我发现被跟踪对象的状态和关系，无论我是在解决问题还是在学习它的工作方式。 让我们转到Model.DebugViews看看您可以从中学到什么。 首先，我应该阐明我的模型。使用Visual Studio中的EF Core Power Tools扩展来可视化模型。</p><p>DbContext.Model.DebugView也具有ShortView和LongView。</p><h4 id="原生sql查询">原生Sql查询</h4><p>原生sql查询使用如下两个方法进行，查询的结构只能映射到dbset关联的对象类型</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DBSet</span><span class="p">.</span><span class="nf">FromSqlRaw</span><span class="p">()</span>
<span class="n">DBSet</span><span class="p">.</span><span class="nf">FromSqlInterpolated</span><span class="p">()</span>
</code></pre></div></div><p>可以使用部分linq扩展方法</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">.</span><span class="nf">FromSqlRaw</span><span class="p">(</span><span class="s">"select * from authors"</span><span class="p">).</span><span class="nf">FirstOrDefault</span><span class="p">(</span><span class="n">a</span><span class="p">=&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">Id</span><span class="p">==</span><span class="m">3</span><span class="p">)</span>
<span class="p">.</span><span class="nf">FromSqlRaw</span><span class="p">(</span><span class="s">"select * from authors"</span><span class="p">).</span><span class="nf">OrderBy</span><span class="p">(</span><span class="n">a</span><span class="p">=&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">LastName</span><span class="p">)</span>
<span class="p">.</span><span class="nf">FromSqlRaw</span><span class="p">(</span><span class="s">"select * from authors"</span><span class="p">).</span><span class="nf">Include</span><span class="p">(</span><span class="n">a</span><span class="p">=&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">Books</span><span class="p">)</span>
<span class="p">.</span><span class="nf">FromSqlRaw</span><span class="p">(</span><span class="s">"select * from authors"</span><span class="p">).</span><span class="nf">AsNoTracking</span><span class="p">()</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">Find</code>方法不受支持</p><h4 id="避免sql注入">避免Sql注入</h4><p>参数化查询</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">.</span><span class="nf">FromSqlRaw</span><span class="p">(</span><span class="s">"select * fro mauthors where lastnmae like '{0}%'"</span><span class="p">,</span><span class="n">lastnameStart</span><span class="p">).</span><span class="nf">TagWith</span><span class="p">(</span><span class="s">"Fromatted_Safe"</span><span class="p">).</span><span class="nf">ToList</span><span class="p">()</span>
<span class="p">.</span><span class="nf">FromSqlRaw</span><span class="p">(</span><span class="s">$"select * fro mauthors where lastnmae like '</span><span class="p">{</span><span class="n">lastnameStart</span><span class="p">}</span><span class="s">%'"</span><span class="p">).</span><span class="nf">TagWith</span><span class="p">(</span><span class="s">"Fromatted_Safe"</span><span class="p">).</span><span class="nf">ToList</span><span class="p">()</span>
<span class="p">.</span><span class="nf">FromSqlInterpolated</span><span class="p">(</span><span class="s">$"select * fro mauthors where lastnmae like '</span><span class="p">{</span><span class="n">lastnameStart</span><span class="p">}</span><span class="s">%'"</span><span class="p">).</span><span class="nf">TagWith</span><span class="p">(</span><span class="s">"Interpolated_Safe"</span><span class="p">).</span><span class="nf">ToList</span><span class="p">()</span>

</code></pre></div></div><p>不安全的查询</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">string</span> <span class="n">sql</span> <span class="p">=</span> <span class="s">$"select * fro mauthors where lastnmae like '</span><span class="p">{</span><span class="n">lastnameStart</span><span class="p">}</span><span class="s">%'"</span><span class="p">;</span>
<span class="p">.</span><span class="nf">FromSqlRaw</span><span class="p">(</span><span class="n">sql</span><span class="p">).</span><span class="nf">TagWith</span><span class="p">(</span><span class="s">"Interpolated_Unsafe"</span><span class="p">).</span><span class="nf">ToList</span><span class="p">()</span>
</code></pre></div></div><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">.</span><span class="nf">FromSqlRaw</span><span class="p">(</span><span class="s">$"select * fro mauthors where lastnmae like '</span><span class="p">{</span><span class="n">lastnameStart</span><span class="p">}</span><span class="s">%'"</span><span class="p">).</span><span class="nf">TagWith</span><span class="p">(</span><span class="s">"Interpolated_Unsafe"</span><span class="p">).</span><span class="nf">ToList</span><span class="p">()</span>
</code></pre></div></div><h5 id="存储过程使用">存储过程使用</h5><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">EXEC</span> <span class="n">thesproc</span> <span class="n">param1</span><span class="p">,</span><span class="n">param2</span><span class="p">,</span><span class="n">param3</span>
</code></pre></div></div><p>添加存储过程</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">add</span><span class="p">-</span><span class="n">migration</span> <span class="n">AddStoredProc</span>
</code></pre></div></div><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">AddStoredProc</span> <span class="p">:</span> <span class="n">Migration</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Up</span><span class="p">(</span><span class="n">MigrationBuilder</span> <span class="n">migrationBuilder</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">migrationBuilder</span><span class="p">.</span><span class="nf">Sql</span><span class="p">(</span><span class="s">@"
        CREATE PROCEDURE dbo.AuthorsPublishedinYearRange
        @yearstart int,
        @yearend int
        AS
        select * from authors as a
        left join books as b  on a.authorid = b.authorId
        where Year(b.PublishDate) &gt;=@yearstart and Year(b.PublishDate) &lt;=@yearend
        "</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Down</span><span class="p">(</span><span class="n">MigrationBuilder</span> <span class="n">migrationBuilder</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">migrationBuilder</span><span class="p">.</span><span class="nf">Sql</span><span class="p">(</span><span class="s">" drop procedure AuthorsPublishedinYearRange"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>执行存储过程</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DBSet</span><span class="p">.</span><span class="nf">FromSqlRaw</span><span class="p">(</span><span class="s">"AuthorsPublishedinYearRange {0},{1}"</span><span class="p">,</span><span class="m">1999</span><span class="p">,</span><span class="m">2010</span><span class="p">);</span>
<span class="n">DBSet</span><span class="p">.</span><span class="nf">FromSqlInterpolated</span><span class="p">(</span><span class="s">$"AuthorsPublishedinYearRange </span><span class="p">{</span><span class="n">start</span><span class="p">}</span><span class="s">,</span><span class="p">{</span><span class="n">end</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
</code></pre></div></div><p>不能使用的方法：Include</p><h4 id="视图的使用方法">视图的使用方法</h4><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//示例，视图返回如下数据</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">AuthorByArtist</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Artist</span> <span class="p">{</span><span class="k">get</span><span class="p">;</span><span class="k">set</span><span class="p">;}</span>
    <span class="k">public</span> <span class="kt">string</span><span class="p">?</span> <span class="n">Author</span> <span class="p">{</span><span class="k">get</span><span class="p">;</span><span class="k">set</span><span class="p">;}</span>
<span class="p">}</span>
<span class="c1">//1、定义Dbset</span>
<span class="k">public</span> <span class="n">virual</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">AuthorByArtist</span><span class="p">&gt;</span> <span class="n">AuthorByArtist</span> <span class="p">{</span><span class="k">get</span><span class="p">;</span><span class="k">set</span><span class="p">;}</span>
<span class="c1">//2、设置Entity</span>
<span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnModelCreating</span><span class="p">(</span><span class="n">ModelBuilder</span> <span class="n">modelBuilder</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">modelBuilder</span><span class="p">.</span><span class="n">Entity</span><span class="p">&lt;</span><span class="n">AuthorByArtist</span><span class="p">&gt;().</span><span class="nf">HasNoKey</span><span class="p">()</span>
    <span class="p">.</span><span class="nf">ToView</span><span class="p">(</span><span class="s">"AuthorByArtist"</span><span class="p">);</span>
    <span class="p">.....</span>
<span class="p">}</span>
</code></pre></div></div><p>没有主键，不能使用Find方法查询数据</p><h4 id="数据库级别执行non-query-raw-sql">数据库级别执行：Non-Query Raw SQL</h4><pre><code class="language-CSharp">_context.Database.ExecuteSQLRaw("update author set a.name = '{0}",newname);
_context.Database.ExecuteSQLRawAsync("update author set a.name = {0}",newname);

_context.Database.ExecuteSQLInterpolated(("update author set a.name = {newname}  where authorid = {id}");
_context.Database.ExecuteSQLInterpolatedAsync("update author set a.name = {newname}  where authorid = {id}");
//执行存储过程
_context.Database.ExecuteSQLRaw("DeleteCover {0}", coverId);
</code></pre><h4 id="testing-with-ef-core">Testing with EF Core</h4><p>单元测试、集成测试、功能测试，其他自动测试</p><ul><li>数据库测试</li></ul><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">Testclass</span><span class="p">]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">DatabaseTests</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">TestMethod</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">CanInsertAuthorIntoDatabase</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="n">newDbContextoptionsBuilder</span><span class="p">&lt;</span><span class="n">PubContext</span><span class="p">&gt;();</span>
        <span class="n">builder</span><span class="p">.</span><span class="nf">UseSglServer</span><span class="p">(</span><span class="s">"Data Source = (localdb)l\MSSQLLocalDB; Initial Catalog = PubTestData"</span><span class="p">);</span>
        <span class="k">using</span><span class="p">(</span><span class="kt">var</span> <span class="n">context</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PubContext</span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="n">Options</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">context</span><span class="p">.</span><span class="n">Database</span><span class="p">.</span><span class="nf">EnsureDeleted</span><span class="p">();</span>
            <span class="n">context</span><span class="p">.</span><span class="n">Database</span><span class="p">.</span><span class="nf">EnsureCreated</span><span class="p">();</span>
            
            <span class="kt">var</span> <span class="n">author</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Author</span> <span class="p">{</span> <span class="n">FirstName</span> <span class="p">=</span> <span class="s">"a"</span><span class="p">,</span> <span class="n">LastName</span> <span class="p">=</span> <span class="s">"b"</span> <span class="p">};</span>
            <span class="n">context</span><span class="p">.</span><span class="n">Authors</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">author</span><span class="p">);</span><span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Before save: (author.AuthorId}"</span><span class="p">);</span>
            <span class="n">context</span><span class="p">.</span><span class="nf">SaveChanges</span><span class="p">();</span>
            <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"After save: (author.AuthorId)"</span><span class="p">);</span>
            <span class="n">Assert</span><span class="p">.</span><span class="nf">AreNotEqual</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">author</span><span class="p">.</span><span class="n">AuthorId</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>asp .net core</p><h4 id="some-more-practical-mappings">Some More Practical Mappings</h4><ul><li>全局配置</li></ul><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">ConfigureConventions</span><span class="p">(</span><span class="n">ModelConfigurationBuilder</span> <span class="n">configurationBuilder</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//此处可配置，全部类型设置</span>
    <span class="n">configurationBuilder</span><span class="p">.</span><span class="n">Properties</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;().</span><span class="nf">HaveColumnType</span><span class="p">(</span><span class="s">"varchar(100)"</span><span class="p">);</span>
    <span class="c1">//全局类型转换</span>
    <span class="n">configurationBuilder</span><span class="p">.</span><span class="n">Properties</span><span class="p">&lt;</span><span class="n">BookGenre</span><span class="p">&gt;).</span><span class="n">HaveConversion</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
    <span class="n">configurationBuilder</span><span class="p">.</span><span class="n">Properties</span><span class="p">&lt;</span><span class="n">Color</span><span class="p">&gt;().</span><span class="nf">HaveConversion</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">ColorTostring</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">//自定义转换类型</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ColorTostring</span> <span class="p">:</span> <span class="n">ValueConverter</span><span class="p">&lt;</span><span class="n">Color</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">ColorTostring</span><span class="p">()</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">Colorstring</span><span class="p">,</span> <span class="n">Colorstruct</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>
    <span class="k">private</span> <span class="k">static</span> <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Color</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;&gt;</span> <span class="n">ColorString</span> <span class="p">=</span> <span class="n">v</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">String</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
    <span class="k">private</span> <span class="k">static</span> <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">Color</span><span class="p">&gt;&gt;</span> <span class="n">Colorstruct</span> <span class="p">=</span> <span class="n">v</span> <span class="p">=&gt;</span> <span class="n">Color</span><span class="p">.</span><span class="nf">FromName</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><h4 id="事务使用">事务使用</h4><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">var</span> <span class="n">transaction</span> <span class="p">=</span> <span class="n">_dbcontext</span><span class="p">.</span><span class="n">Database</span><span class="p">.</span><span class="nf">BeginTransaction</span><span class="p">();</span>
<span class="p">....</span>
<span class="n">_dbcontext</span><span class="p">.</span><span class="n">Database</span><span class="p">.</span><span class="nf">ExecuteSqlInterpolated</span><span class="p">(</span><span class="s">$"delete from books where bookid=</span><span class="p">{</span><span class="n">bookid</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="n">_dbcontext</span><span class="p">.</span><span class="nf">SaveChanges</span><span class="p">();</span>
<span class="n">transcation</span><span class="p">.</span><span class="nf">Commit</span><span class="p">();</span>
<span class="p">....</span>
</code></pre></div></div><p>并发处理</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span>
<span class="p">{</span>
    <span class="n">context</span><span class="p">.</span><span class="nf">SaveChanges</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">catch</span><span class="p">(</span><span class="n">DBUpdateConcurrencyException</span> <span class="n">ex</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//处理并发异常</span>
<span class="p">}</span>
</code></pre></div></div><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//使用连接池</span>
<span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddDbContextPool</span><span class="p">&lt;</span><span class="n">PUbContext</span><span class="p">&gt;(</span><span class="n">opt</span> <span class="p">=&gt;{</span>
<span class="p">....</span>
<span class="n">opt</span><span class="p">.</span>
    <span class="p">}</span>
<span class="p">);</span>

<span class="c1">//自动重连</span>
<span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnConfiguring</span><span class="p">(</span><span class="n">DbContextoptionsBuilder</span> <span class="n">optionsBuilder</span><span class="p">)</span>
<span class="p">{</span> 
    <span class="n">optionsBuilder</span><span class="p">.</span><span class="nf">UseSglServer</span><span class="p">(</span><span class="n">myconnectionoptions</span><span class="p">=&gt;</span><span class="n">options</span><span class="p">.</span><span class="nf">EnableRetryOnFailure</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div><h4 id="ef-pipeline-event">EF Pipeline Event</h4><ul><li>DBContext.SaveingChanges</li><li>DBContext.SavedChanges</li><li>DbContext.SaveChangesFailed</li><li>ChangeTracker.Tracked</li><li>ChangeTracker.SateChanged</li></ul><h4 id="intercepting-database-operations">Intercepting Database Operations</h4><table><thead><tr><th>Interceptor</th><th>Database operations intercepted</th></tr></thead><tbody><tr><td>IDbCommandInterceptor</td><td>发送命令到数据库前、命令执行失败，释放DbDataReader</td></tr><tr><td>IDbConnectionInterceptor</td><td>打开或关闭连接，连接失败</td></tr><tr><td>IDbTranscationInterceptor</td><td>创建事务，使用存在的事务，事务提交前，回滚事务，创建和使用新的保存点，事务失败</td></tr></tbody></table><p>注入</p><div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">opt</span><span class="p">-&gt;</span><span class="n">opt</span><span class="p">.</span><span class="nf">AddINterceptors</span><span class="p">(</span><span class="k">new</span> <span class="nf">MyInterceptor</span><span class="p">());</span>
</code></pre></div></div><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="https://zmngw.github.io" target="_blank">zhoubin</a></li><li>本文链接：<a href="https://zmngw.github.io/2023/09/16/EFCoreInfo/" target="_blank">https://zmngw.github.io/2023/09/16/EFCoreInfo/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"> <script src="https://giscus.app/client.js" data-repo="usteinfo/blog-comments" data-repo-id="R_kgDOKL8L_A" data-category="Announcements" data-category-id="DIC_kwDOKL8L_M4CY4xg" data-mapping="title" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async> </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://zmngw.github.io/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://zmngw.github.io/assets/search_data.json?v=1707228410', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://zmngw.github.io/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2023 <span title="zhoubin">zhoubin</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/usteinfo/usteinfo.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://zmngw.github.io/" title="首页" target="">首页</a></li><li> <a href="https://zmngw.github.io/categories/" title="分类" target="">分类</a></li><li> <a href="https://zmngw.github.io/archives/" title="归档" target="">归档</a></li><li> <a href="https://zmngw.github.io/open-source/" title="开源" target="">开源</a></li><li> <a href="https://zmngw.github.io/fragments/" title="片段" target="">片段</a></li><li> <a href="https://zmngw.github.io/wiki/" title="维基" target="">维基</a></li><li> <a href="https://zmngw.github.io/links/" title="链接" target="">链接</a></li><li> <a href="https://zmngw.github.io/about/" title="关于" target="">关于</a></li><li><a href="https://zmngw.github.io/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul><script async src="https://zmngw.github.io/assets/vendor/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="mobile-hidden" style="margin-top:8px"> <span id="busuanzi_container_site_pv" style="display:none"> 本站访问量<span id="busuanzi_value_site_pv"></span>次 </span> <span id="busuanzi_container_site_uv" style="display:none"> / 本站访客数<span id="busuanzi_value_site_uv"></span>人 </span> <span id="busuanzi_container_page_pv" style="display:none"> / 本页访问量<span id="busuanzi_value_page_pv"></span>次 / 统计始于2023-09-02 </span></div></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://zmngw.github.io/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script></body></html>
