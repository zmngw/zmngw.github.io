<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>数据仓库建设规范指南 &mdash; 码农感悟</title><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/usteinfo/usteinfo.github.io@master/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/usteinfo/usteinfo.github.io@master/assets/css/components/collection.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/usteinfo/usteinfo.github.io@master/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/usteinfo/usteinfo.github.io@master/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/usteinfo/usteinfo.github.io@master/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/usteinfo/usteinfo.github.io@master/assets/css/globals/common.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/usteinfo/usteinfo.github.io@master/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/usteinfo/usteinfo.github.io@master/assets/css/posts/index.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/usteinfo/usteinfo.github.io@master/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/mzlogin/rouge-themes@master/dist/github.css"><link rel="canonical" href="https://zmngw.github.io/2023/11/05/%E6%95%B0%E4%BB%93%E5%BB%BA%E8%AE%BE%E8%A7%84%E8%8C%83%E6%8C%87%E5%8D%97/"><link rel="alternate" type="application/atom+xml" title="码农感悟" href="https://zmngw.github.io/feed.xml"><link rel="shortcut icon" href="https://fastly.jsdelivr.net/gh/usteinfo/usteinfo.github.io@master/favicon.ico"><meta property="og:title" content="数据仓库建设规范指南"><meta name="keywords" content="数仓, 规范,指南"><meta name="og:keywords" content="数仓, 规范,指南"><meta name="description" content="一、数据模型架构原则"><meta name="og:description" content="一、数据模型架构原则"><meta property="og:url" content="https://zmngw.github.io/2023/11/05/%E6%95%B0%E4%BB%93%E5%BB%BA%E8%AE%BE%E8%A7%84%E8%8C%83%E6%8C%87%E5%8D%97/"><meta property="og:site_name" content="码农感悟"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2023-11-05"> <script src="https://fastly.jsdelivr.net/gh/usteinfo/usteinfo.github.io@master/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://fastly.jsdelivr.net/gh/usteinfo/usteinfo.github.io@master/assets/js/main.js"></script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://zmngw.github.io/" title="码农感悟"><span class="octicon octicon-mark-github"></span> 码农感悟</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://zmngw.github.io/" class="site-header-nav-item" target="" title="首页">首页</a> <a href="https://zmngw.github.io/categories/" class="site-header-nav-item" target="" title="分类">分类</a> <a href="https://zmngw.github.io/archives/" class="mobile-hidden site-header-nav-item" target="" title="归档">归档</a> <a href="https://zmngw.github.io/open-source/" class="mobile-hidden site-header-nav-item" target="" title="开源">开源</a> <a href="https://zmngw.github.io/fragments/" class="site-header-nav-item" target="" title="片段">片段</a> <a href="https://zmngw.github.io/wiki/" class="site-header-nav-item" target="" title="维基">维基</a> <a href="https://zmngw.github.io/links/" class="mobile-hidden site-header-nav-item" target="" title="链接">链接</a> <a href="https://zmngw.github.io/about/" class="site-header-nav-item" target="" title="关于">关于</a> <a class="mobile-hidden" href="https://zmngw.github.io/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="数据仓库建设规范指南"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">数据仓库建设规范指南</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2023/11/05 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://zmngw.github.io/categories/#数仓" title="数仓">数仓</a> </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://zmngw.github.io/categories/#指南" title="指南">指南</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 8730 字，约 25 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"> <img style="height:72px;width:72px" src="https://zmngw.github.io/assets/images/qrcode.jpg" alt="码农感悟" /></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><h2 id="一数据模型架构原则">一、数据模型架构原则</h2><p>优秀可靠的数仓体系，往往需要清晰的数据分层结构，即要保证数据层的稳定又要屏蔽对下游的影响，并且要避免链路过长。那么问题来了，一直在讲数仓要分层，那数仓分几层最好？</p><p>分层是以解决当前业务快速的数据支撑为目的，为未来抽象出共性的框架并能够赋能给其他业务线，同时为业务发展提供稳定、准确的数据支撑，并能够按照已有的模型为新业务发展提供方向，也就是数据驱动和赋能。</p><p>好的分层架构，有以下好处：</p><ul><li>清晰数据结构；</li><li>数据血缘追踪；</li><li>减少重复开发；</li><li>数据关系条理化；</li><li>屏蔽原始数据的影响。</li></ul><h2 id="二数据分层架构">二、数据分层架构</h2><p>数仓建模在哪层建设呢？我们以维度建模为例，建模是在数据源层的下一层进行建设，就是在DW层进行数仓建模，所以DW层是数仓建设的核心层。</p><p>下面详细阐述下每层建设规范：</p><h3 id="21-数据源层odsoperational-data-store">2.1 数据源层：ODS（Operational Data Store）</h3><p>ODS 层，是最接近数据源中数据的一层，为了考虑后续可能需要追溯数据问题，因此对于这一层就不建议做过多的数据清洗工作，原封不动地接入原始数据即可，至于数据的去噪、去重、异常值处理等过程可以放在后面的 DWD 层来做。</p><h3 id="22-数据仓库层dwdata-warehouse">2.2 数据仓库层：DW（Data Warehouse）</h3><p>数据仓库层是我们在做数据仓库时要核心设计的一层，在这里，从 ODS 层中获得的数据按照主题建立各种数据模型。</p><p>DW 层又细分为 <strong>DWD</strong>（Data Warehouse Detail）层、<strong>DWM</strong>（Data WareHouse Middle）层和 <strong>DWS</strong>（Data WareHouse Servce） 层。</p><h4 id="221-数据明细层dwddata-warehouse-detail">2.2.1 数据明细层：DWD（Data Warehouse Detail）</h4><p>该层一般保持和 ODS 层一样的数据粒度，并且提供一定的数据质量保证。DWD 层要做的就是将数据清理、整合、规范化、脏数据、垃圾数据、规范不一致的、状态定义不一致的、命名不规范的数据都会被处理。</p><p>同时，为了提高数据明细层的易用性，该层会采用一些<strong>维度退化手法，将维度退化至事实表中，减少事实表和维表的关联</strong>。</p><p>另外，在该层也会做一部分的数据聚合，将相同主题的数据汇集到一张表中，提高数据的可用性 。</p><h4 id="222-数据中间层dwmdata-warehouse-middle">2.2.2 数据中间层：DWM（Data WareHouse Middle）</h4><p>该层会在 DWD 层的数据基础上，数据做轻度的聚合操作，生成一系列的中间表，提升公共指标的复用性，减少重复加工。直观来讲，就是对通用的核心维度进行聚合操作，算出相应的统计指标。</p><p>在实际计算中，如果直接从 DWD 或者 ODS 计算出宽表的统计指标，会存在计算量太大并且维度太少的问题，因此一般的做法是，在 DWM 层先计算出多个小的中间表，然后再拼接成一张 DWS 的宽表。由于宽和窄的界限不易界定，也可以去掉 DWM 这一层，只留 DWS 层，将所有的数据再放在 DWS 亦可。</p><h4 id="223-数据服务层dwsdata-warehouse-servce">2.2.3 数据服务层：DWS（Data WareHouse Servce）</h4><p>DWS 层为公共汇总层，会进行轻度汇总，粒度比明细数据稍粗，基于 DWD 层上的基础数据，整合汇总成分析某一个主题域的服务数据，一般是宽表。DWS 层应覆盖 80% 的应用场景。又称数据集市或宽表。</p><p>按照业务划分，如主题域流量、订单、用户等，生成字段比较多的宽表，用于提供后续的业务查询，OLAP 分析，数据分发等。</p><p>一般来讲，该层的数据表会相对比较少，一张表会涵盖比较多的业务内容，由于其字段较多，因此一般也会称该层的表为宽表。</p><h3 id="3--数据应用层appapplication">3. 数据应用层：APP（Application）</h3><p>在这里，主要是提供给数据产品和数据分析使用的数据，一般会存放在 ES、 PostgreSql、Redis 等系统中供线上系统使用，也可能会存在 Hive 或者 Druid 中供数据分析和数据挖掘使用。比如我们经常说的报表数据，一般就放在这里。</p><h3 id="4-维表层dimension">4. 维表层（Dimension）</h3><p>如果维表过多，也可针对维表设计单独一层，维表层主要包含两部分数据：</p><ul><li>高基数维度数据：一般是用户资料表、商品资料表类似的资料表。<strong>数据量可能是千万级或者上亿级别</strong>。</li><li>低基数维度数据：一般是配置表，比如枚举值对应的中文含义，或者日期维表。数据量可能是个位数或者几千几万。</li></ul><h3 id="5-主题域划分原则">5. 主题域划分原则</h3><h4 id="51-按照业务或业务过程划分">5.1 按照业务或业务过程划分</h4><p>业务容易理解，就是指的功能模块/业务线。</p><p><strong>业务过程</strong>：指企业的业务活动事件，如下单、支付、退款都是业务过程。需要注意的是，<strong>一个业务过程是一个不可拆分的行为事件，通俗的讲，业务过程就是企业活动中的事件</strong>。</p><h4 id="52-按照数据域划分">5.2 按照数据域划分</h4><p>数据域是指面向业务分析，将业务过程或者维度进行抽象的集合。</p><p>其中，业务过程可以概括为一个个不可拆分的行为事件，在业务过程下，可以定义指标，维度是指度量的环境，如买家下单事件，买家是维度。为保障整个体系的生命力，数据域是需要抽象提炼，并且长期维护和更新的，但不轻易变动。</p><p>在划分数据域时，既能涵盖当前所有的业务需求，又能在新业务进入时无影响地被包含进已有的数据域中和扩展新的数据域。</p><h3 id="6-数据模型设计原则">6 数据模型设计原则</h3><p>1) 高内聚、低耦合</p><p>即主题内部高内聚、 不同主题间低耦合。明细层按照业务过程划分主题，汇总层按照“实体+ 活动”划分不同分析主题，应用层根据应用需求划分不同应用主题。</p><p>2) 核心模型和扩展模型要分离</p><p>建立核心模型与扩展模型体系，核心模型包括的字段支持常用的核心业务，扩展模型包括的字段支持个性化或少量应用的需要，不能让扩展模型的字段过度侵入核心模型，以免破坏核心模型的架构简洁性与可维护性。</p><p>3) 公共处理逻辑下沉及单一</p><p>越是底层公用的处理逻辑越应该在数据调度依赖的底层进行封装与实现，不要让公用的处理逻辑暴露给应用实现，不要让公共逻辑多处同时存在。</p><p>4) 成本与性能平衡</p><p>适当的数据冗余可换取查询和刷新性能，不宜过度冗余与数据复制。</p><p>5) 数据可回滚</p><p>处理逻辑不变，在不同时间多次运行数据结果确定不变。</p><h2 id="三数仓公共开发规范">三、数仓公共开发规范</h2><h3 id="31-层次调用规范">3.1 层次调用规范</h3><p>稳定业务按照标准的数据流向进行开发，即 ODS –&gt; DWD –&gt; DWS –&gt; APP。非稳定业务或探索性需求，可以遵循 ODS -&gt; DWD -&gt; APP 或者 ODS -&gt; DWD -&gt; DWM -&gt;APP 两个模型数据流。</p><p>在保障了数据链路的合理性之后，也必须保证模型分层引用原则：</p><p>正常流向：ODS -&gt; DWD -&gt; DWM -&gt; DWS -&gt; APP，当出现 ODS -&gt; DWD -&gt; DWS -&gt; APP</p><p>这种关系时，说明主题域未覆盖全。应将 DWD 数据落到 DWM 中，对于使用频度非常低的表允许 DWD -&gt; DWS。</p><p>尽量避免出现 DWS 宽表中使用 DWD 又使用（该 DWD 所归属主题域）DWM 的表。</p><p>同一主题域内对于 DWM 生成 DWM 的表，原则上要尽量避免，否则会影响 ETL 的效率。 DWM、DWS 和 APP 中禁止直接使用 ODS 的表， ODS 的表只能被 DWD 引用。 禁止出现反向依赖，例如 DWM 的表依赖 DWS 的表。</p><h3 id="32-数据类型规范">3.2 数据类型规范</h3><p>需统一规定不同的数据的数据类型，严格按照规定的数据类型执行：</p><table><thead><tr><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>金额</td><td>使用 decimal(28,6) 控制精度等，明确单位是分还是元</td></tr><tr><td>字符串</td><td>string</td></tr><tr><td>id类</td><td>bigint</td></tr><tr><td>时间</td><td>string,明确时间定义的格式</td></tr><tr><td>状态</td><td>string</td></tr></tbody></table><h3 id="33-数据冗余规范">3.3 数据冗余规范</h3><p>宽表的冗余字段要确保：</p><ul><li>冗余字段要<strong>使用高频，下游3个或以上使用</strong>。</li><li>冗余字段引入<strong>不应造成本身数据产生过多的延后</strong>。</li><li>冗余字段和已有字段的<strong>重复率不应过大，原则上不应超过60%</strong>，如需要可以选择join或原表拓展。</li></ul><h3 id="34-null字段处理规范">3.4 NULL字段处理规范</h3><ul><li>维度字段，需设置为-1</li><li>指标字段，需设置为 0</li></ul><h3 id="35-指标口径规范">3.5 指标口径规范</h3><p>保证主题域内，指标口径一致，无歧义。</p><p>通过数据分层，提供统一的数据出口，统一对外输出的数据口径，避免同一指标不同口径的情况发生。</p><p>1) 指标梳理</p><p>指标口径的不一致使得数据使用的成本极高，经常出现口径打架、反复核对数据的问题。在数据治理中，我们将需求梳理到的所有指标进行进一步梳理，明确其口径，<strong>如果存在两个指标名称相同，但口径不一致，先判断是否是进行合并，如需要同时存在，那么在命名上必须能够区分开</strong>。</p><p>2) 指标管理</p><p>指标管理分为<strong>原子指标维护</strong>和<strong>派生指标维护</strong>。</p><ul><li>原子指标：<ul><li>选择原子指标的归属产线、业务板块、数据域、业务过程</li><li>选择原子指标的统计数据来源于该业务过程下的原始数据源</li><li>录入原子指标的英文名称、中文名称、概述</li><li>填写指标函数</li><li>系统根据指标函数自动生成原子指标的定义表达式</li><li>系统根据指标定义表达式以及数据源表生成原子指标SQL</li></ul></li><li>派生指标： 在原子指标的基础之上选择了一些维度或者修饰限定词。</li></ul><h3 id="36-数据表处理规范">3.6 数据表处理规范</h3><p>1) 增量表</p><ul><li>新增数据，增量数据是上次导出之后的新数据。</li><li>记录每次增加的量，而不是总量；</li><li>增量表，只报变化量，无变化不用报；</li><li>每天一个分区。</li></ul><p>2) 全量表</p><ul><li>每天的所有的最新状态的数据。</li><li>全量表，有无变化，都要报；</li><li>每次上报的数据都是所有的数据（变化的 + 没有变化的）；</li><li>只有一个分区。</li></ul><p>3) 快照表</p><ul><li>按日分区，记录截止数据日期的全量数据。</li><li>快照表，有无变化，都要报；</li><li>每次上报的数据都是所有的数据（变化的 + 没有变化的）；</li><li>一天一个分区。</li></ul><p>4) 拉链表</p><ul><li>记录截止数据日期的全量数据。</li><li>记录一个事物从开始，一直到当前状态的所有变化的信息；</li><li>拉链表每次上报的都是历史记录的最终状态，是记录在当前时刻的历史总 量；</li><li>当前记录存的是当前时间之前的所有历史记录的最后变化量（总量）；</li><li>只有一个分区。</li></ul><h3 id="37-表的生命周期管理">3.7 表的生命周期管理</h3><p>这部分主要是要通过对历史数据的等级划分与对表类型的划分生成相应的生命周期管理矩阵。</p><p>1) 历史数据等级划分 主要将历史数据划分P0、Pl、P2、P3 四个等级，其具体定义如下：</p><ul><li>P0 ：非常重要的主题域数据和非常重要的应用数据，具有不可恢复性，如交易、日志、集团 KPI 数据、 IPO 关联表。</li><li>Pl ：重要的业务数据和重要的应用数据，具有不可恢复性，如重要的业务产品数据。</li><li>P2 ：重要的业务数据和重要的应用数据，具有可恢复性，如交易线 ETL 产生的中间过程数据。</li><li>P3 ：不重要的业务数据和不重要的应用数据，具有可恢复性，如某些 SNS 产品报表。</li></ul><p>2) 表类型划分</p><ul><li>事件型流水表（增量表）指数据无重复或者无主键数据，如日志。</li><li>事件型镜像表（增量表）指业务过程性数据，有主键，但是对于同样主键的属性会发生缓慢变化，如交易、订单状态与时间会根据业务发生变更。</li><li>维表:维表包括维度与维度属性数据，如用户表、商品表。</li><li>Merge 全量表包括业务过程性数据或者维表数据。由于数据本身有新增的或者发生状态变更，对于同样主键的数据可能会保留多份，因此可以对这些数据根据主键进行 Merge 操作，主键对应的属性只会保留最新状态，历史状态保留在前一天分区 中。例如，用户表、交易表等都可以进行 Merge 操作</li><li>ETL 临时表是指 ETL 处理过程中产生的临时表数据，一般不建议保留，最多7天。</li><li>TT 拉取的数据和 DbSync 产生的临时数据最终会流转到 DS 层，ODS 层数据作为原始数据保留下来，从而使得 TT&amp;DbSync 上游数据成为临时数据。这类数据不建议保留很长时间，生命周期默认设置为 93天，可以根据实际情况适当减少保留天数。</li></ul><h3 id="38-普通全量表">3.8 普通全量表</h3><p>很多小业务数据或者产品数据，BI一般是直接全量拉取，这种方式效率快，对存储压力也不是很大，而且表保留很长时间，可以根据历史数据等级确定保留策略。</p><h2 id="四数仓各层开发规范">四、数仓各层开发规范</h2><h3 id="41-ods层设计规范">4.1 ODS层设计规范</h3><ul><li><p>同步规范： 一个系统源表只允许同步一次； 全量初始化同步和增量同步处理逻辑要清晰； 以统计日期和时间进行分区存储； 目标表字段在源表不存在时要自动填充处理。</p></li><li>表分类与生命周期：<ol><li><p>ods流水全量表：</p><p>不可再生的永久保存； 日志可按留存要求； 按需设置保留特殊日期数据； 按需设置保留特殊月份数据；</p></li><li><p>ods镜像型全量表：</p><p>推荐按天存储； 对历史变化进行保留； 最新数据存储在最大分区； 历史数据按需保留；</p></li><li><p>ods增量数据： 推荐按天存储； 有对应全量表的，建议只保留14天数据； 无对应全量表的，永久保留；</p></li><li>ods的etl过程中的临时表： 推荐按需保留； 最多保留7天； 建议用完即删，下次使用再生成；</li><li>BDSync非去重数据： 通过中间层保留，默认用完即删，不建议保留。</li></ol></li><li><p>数据质量：</p><ul><li>全量表必须配置唯一性字段标识；</li><li>对分区空数据进行监控；</li><li>对枚举类型字段，进行枚举值变化和分布监控；</li><li>ods表数据量级和记录数做环比监控；</li><li>ods全表都必须要有注释；</li></ul></li></ul><h3 id="42-公共维度层设计规范">4.2 公共维度层设计规范</h3><p>1) 设计准则</p><ul><li>一致性 <strong>共维度在不同的物理表中的字段名称、数据类型、数据内容必须保持一致</strong>（历史原因不一致，要做好<strong>版本控制</strong>） 维度的组合与拆分</li><li>组合原则： 将维度与关联性强的字段进行组合，一起查询，一起展示，两个维度必须具有天然的关系，如：商品的基本属性和所属品牌。</li><li>无相关性：如一些使用频率较小的杂项维度，可以构建一个集合杂项维度的特殊属性。</li><li>行为维度：经过计算的度量，但下游当维度处理，例：点击量 0-1000,100-1000等，可以做聚合分类。 拆分与冗余： 针对重要性，业务相关性、源、使用频率等可分为核心表、扩展表。 数据记录较大的维度，可以适当冗余一些子集。</li></ul><p>2) 存储及生命周期管理 建议按天分区。</p><ol><li>3个月内最大访问跨度&lt;=4天时，建议保留最近7天分区；</li><li>3个月内最大访问跨度&lt;=12天时，建议保留最近15天分区；</li><li>3个月内最大访问跨度&lt;=30天时，建议保留最近33天分区；</li><li>3个月内最大访问跨度&lt;=90天时，建议保留最近120天分区；</li><li>3个月内最大访问跨度&lt;=180天时，建议保留最近240天分区；</li><li>3个月内最大访问跨度&lt;=300天时，建议保留最近400天分区；</li></ol><h3 id="43-dwd明细层设计规范">4.3 DWD明细层设计规范</h3><p>1) 存储及生命周期管理 建议按天分区。</p><ol><li>3个月内最大访问跨度&lt;=4天时，建议保留最近7天分区；</li><li>3个月内最大访问跨度&lt;=12天时，建议保留最近15天分区；</li><li>3个月内最大访问跨度&lt;=30天时，建议保留最近33天分区；</li><li>3个月内最大访问跨度&lt;=90天时，建议保留最近120天分区；</li><li>3个月内最大访问跨度&lt;=180天时，建议保留最近240天分区；</li><li>3个月内最大访问跨度&lt;=300天时，建议保留最近400天分区；</li></ol><p>2) 事务型事实表设计准则</p><ul><li>基于数据应用需求的分析设计事务型事实表，结合下游较大的针对某个业务过程和分析指标需求，可考虑基于某个事件过程构建事务型实时表；</li><li>一般选用事件的发生日期或时间作为分区字段，便于扫描和裁剪；</li><li>冗余子集原则，有利于降低后续IO开销；</li><li>明细层事实表维度退化，减少后续使用join成本。</li></ul><p>3) 周期快照事实表 周期快照事实表中的每行汇总了发生在某一标准周期，如某一天、某周、某月的多个度量事件。</p><ul><li>粒度是周期性的，不是个体的事务。</li><li>通常包含许多事实，因为任何与事实表粒度一致的度量事件都是被允许的。</li></ul><p>4) 累积快照事实表 多个业务过程联合分析而构建的事实表，如采购单的流转环节。</p><ul><li>用于分析事件时间和时间之间的间隔周期。</li><li>少量的且当前事务型不支持的，如关闭、发货等相关的统计。</li></ul><h3 id="44-dws公共汇总层设计规范">4.4 DWS公共汇总层设计规范</h3><p>数据仓库的性能是数据仓库建设是否成功的重要标准之一。聚集主要是通过汇总明细粒度数据来获得改进查询性能的效果。通过访问聚集数据，可以减少数据库在响应查询时必须执行的工作量，能够快速响应用户的查询，同时有利于减少不同用访问明细数据带来的结果不一致问题。</p><p>1) 聚集的基本原则</p><ul><li>一致性。聚集表必须提供与查询明细粒度数据一致的查询结果。</li><li>避免单一表设计。不要在同一个表中存储不同层次的聚集数据。</li><li>聚集粒度可不同。聚集并不需要保持与原始明细粒度数据一样的粒度，聚集只关心所需要查询的维度。</li></ul><p>2) 聚集的基本步骤</p><ul><li>第一步：确定聚集维度 在原始明细模型中会存在多个描述事实的维度，如日期、商品类别、卖家等，这时候需要确定根据什么维度聚集，如果只关心商品的交易额情况，那么就可以根据商品维度聚集数据。</li><li>第二步：确定一致性上钻 这时候要关心是按月汇总还是按天汇总，是按照商品汇总还是按照类目汇总，如果按照类目汇总，还需要关心是按照大类汇总还是小类汇总。当然，我们要做的只是了解用户需要什么，然后按照他们想要的进行聚集。</li><li>第三步：确定聚集事实 在原始明细模型中可能会有多个事实的度量，比如在交易中有交易额、交易数量等，这时候要明确是按照交易额汇总还是按照成交数量汇总。</li></ul><p>3) 公共汇总层设计原则 除了聚集基本的原则外，公共汇总层还必须遵循以下原则：</p><ul><li>数据公用性。汇总的聚集会有第三者使用吗？基于某个维度的聚集是不是经常用于数据分析中？如果答案是肯定的，那么就有必要把明细数据经过汇总沉淀到聚集表中。</li><li>不跨数据域。数据域是在较高层次上对数据进行分类聚集的抽象。如以业务</li><li>区分统计周期。在表的命名上要能说明数据的统计周期，如 _Id表示最近1天，_td 表示截至当天，_nd 表示最近N天。</li></ul><h2 id="五数仓命名规范">五、数仓命名规范</h2><h3 id="51-词根设计规范">5.1 词根设计规范</h3><p>词根属于数仓建设中的规范，属于元数据管理的范畴，现在把这个划到数据治理的一部分。完整的数仓建设是包含数据治理的，只是现在谈到数仓偏向于数据建模， 而谈到数据治理，更多的是关于数据规范、数据管理。</p><p>表命名，其实在很大程度上是对元数据描述的一种体现，表命名规范越完善，我 们能从表名获取到的信息就越多。比如：一部分业务是关于货架的，英文名是：rack， rack 就是一个词根，那我们就在所有的表、字段等用到的地方都叫 rack，不要叫成 别的什么。这就是词根的作用，用来统一命名，表达同一个含义。</p><p>指标体系中有很多“率”的指标，都可以拆解成 XXX+率，率可以叫 rate，那我 们所有的指标都叫做 XXX+rate。</p><p><strong>词根</strong>：可以用来统一表名、字段名、主题域名等等。</p><p>举例：以流程图的方式来展示，更加直观和易懂，本图侧重 dwm 层表的命名 规范，其余命名是类似的道理： <img src="/assets/images/post/datawarehousetablename.jpg" alt="命名选择规则" /></p><p>第一个判断条件是该表的用途，是中间表、原始日志还是业务展示用的表</p><p>如果该表被判断为中间表，就会走入下一个判断条件：表是否有 group 操作 <strong>通过是否有 group 操作来判断该表该划分在 dwd 层还是 dwm 和 dws 层</strong></p><p>如果不是 dwd 层，则需要判断该表是否是多个行为的汇总表（即宽表） 最后再分别填上事业群、部门、业务线、自定义名称和更新频率等信息即可。</p><ul><li>分层：表的使用范围</li><li>事业群和部门：生产该表或者该数据的团队</li><li>业务线：表明该数据是哪个产品或者业务线相关</li><li>主题域：分析问题的角度，对象实体</li><li>自定义：一般会尽可能多描述该表的信息，比如活跃表、留存表等</li><li>更新周期：比如说天级还是月级更新</li></ul><p>数仓表的命名规范如下：</p><ol><li>数仓层次:<ul><li>公用维度：dim</li><li>DM层：dm</li><li>ODS层：ods</li><li>DWD层：dwd</li><li>DWS层：dws</li></ul></li><li>周期/数据范围：<ul><li>日快照：d</li><li>增量：i</li><li>全量：f</li><li>周：w</li><li>拉链表：l</li><li>非分区全量表：a</li></ul></li></ol><h3 id="52-表命名规范">5.2 表命名规范</h3><p>1) 常规表</p><p>常规表是我们需要固化的表，是正式使用的表，是目前一段时间内需要去维护去 完善的表。</p><p>规范：分层前缀[dwd|dws|ads]_部门_业务域_主题域_XXX_更新周期|数据范围 业务域、主题域我们都可以用词根的方式枚举清楚，不断完善。</p><p>更新周期主要的是时间粒度、日、月、年、周等。</p><p>2) 中间表</p><p>中间表一般出现在 Job 中，是 Job 中临时存储的中间数据的表，中间表的作 用域只限于当前 Job 执行过程中，Job 一旦执行完成，该中间表的使命就完 成了，是可以删除的（按照自己公司的场景自由选择，以前公司会保留几天 的中间表数据，用来排查问题）。</p><p>规范：mid_table_name_[0~9|dim] table_name 是我们任务中目标表的名字，通常来说一个任务只有一个目标表。这里加上表名，是为了防止自由发挥的时候表名冲突，而末尾大家可以选择自由发挥，起一些有意义的名字，或者简单粗暴，使用数字代替，各有优劣吧，谨慎选择。</p><p>通常会遇到需要补全维度的表，这里使用 dim 结尾。</p><p>如果要保留历史的中间表，可以加上日期或者时间戳。</p><p>3) 临时表</p><p>临时表是临时测试的表，是临时使用一次的表，就是暂时保存下数据看看，后续一般不再使用的表，是可以随时删除的表。</p><p>规范：tmp_xxx</p><p>只要加上 tmp 开头即可，其他名字随意，注意 tmp 开头的表不要用来实际使用，只是测试验证而已。</p><p>4) 维度表</p><p>维度表是基于底层数据，抽象出来的描述类的表。维度表可以自动从底层表抽象出来，也可以手工来维护。</p><p>规范：dim_xxx</p><p>维度表，统一以 dim 开头，后面加上，对该指标的描述。</p><p>5) 手工表</p><p>手工表是手工维护的表，手工初始化一次之后，一般不会自动改变，后面变更，也是手工来维护。</p><p>一般来说，手工的数据粒度是偏细的，所以暂时统一放在 dwd 层，后面如果有目标值或者其他类型手工数据，再根据实际情况分层。</p><p>规范：dwd_业务域_manual_xxx</p><p>手工表，增加特殊的主题域，manual，表示手工维护表。</p><h3 id="53-指标命名规范">5.3 指标命名规范</h3><h4 id="1-公共规则">1) 公共规则</h4><ul><li>所有单词小写</li><li>单词之间下划线分割（反例：appName 或 AppName）</li><li>可读性优于长度 (词根，避免出现同一个指标，命名一致性)</li><li>禁止使用 sql 关键字，如字段名与关键字冲突时 +col</li><li>数量字段后缀 _cnt 等标识…</li><li>金额字段后缀 _price 标识</li><li>天分区使用字段 dt，格式统一（yyyymmdd 或 yyyy-mm-dd）</li><li>小时分区使用字段 hh，范围（00-23）</li><li>分钟分区使用字段 mi，范围（00-59）</li><li>布尔类型标识：is_{业务}，不允许出现空值</li></ul><h4 id="2-指标命名规范">2) 指标命名规范</h4><p>结合指标的特性以及词根管理规范，将指标进行结构化处理。</p><ol><li><p>基础指标词根，即所有指标必须包含以下基础词根：</p></li><li><p>业务修饰词，用于描述业务场景的词汇，例如trade-交易。</p></li><li><p>日期修饰词，用于修饰业务发生的时间区间。</p></li><li><p>聚合修饰词，对结果进行聚集操作。</p></li><li>基础指标，单一的业务修饰词+基础指标词根构建基础指标 ，例如：交易金额-trade_amt。</li><li>派生指标，多修饰词+基础指标词根构建派生指标。派生指标继承基础指标的特性，例如：安装门店数量-install_poi_cnt。</li><li>普通指标命名规范，与字段命名规范一致，由词汇转换即可以。</li></ol><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="https://zmngw.github.io" target="_blank">zhoubin</a></li><li>本文链接：<a href="https://zmngw.github.io/2023/11/05/%E6%95%B0%E4%BB%93%E5%BB%BA%E8%AE%BE%E8%A7%84%E8%8C%83%E6%8C%87%E5%8D%97/" target="_blank">https://zmngw.github.io/2023/11/05/%E6%95%B0%E4%BB%93%E5%BB%BA%E8%AE%BE%E8%A7%84%E8%8C%83%E6%8C%87%E5%8D%97/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"> <script src="https://giscus.app/client.js" data-repo="usteinfo/blog-comments" data-repo-id="R_kgDOKL8L_A" data-category="Announcements" data-category-id="DIC_kwDOKL8L_M4CY4xg" data-mapping="title" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async> </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://fastly.jsdelivr.net/gh/usteinfo/usteinfo.github.io@master/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://zmngw.github.io/assets/search_data.json?v=1707143074', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://fastly.jsdelivr.net/gh/usteinfo/usteinfo.github.io@master/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2023 <span title="zhoubin">zhoubin</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/usteinfo/usteinfo.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://zmngw.github.io/" title="首页" target="">首页</a></li><li> <a href="https://zmngw.github.io/categories/" title="分类" target="">分类</a></li><li> <a href="https://zmngw.github.io/archives/" title="归档" target="">归档</a></li><li> <a href="https://zmngw.github.io/open-source/" title="开源" target="">开源</a></li><li> <a href="https://zmngw.github.io/fragments/" title="片段" target="">片段</a></li><li> <a href="https://zmngw.github.io/wiki/" title="维基" target="">维基</a></li><li> <a href="https://zmngw.github.io/links/" title="链接" target="">链接</a></li><li> <a href="https://zmngw.github.io/about/" title="关于" target="">关于</a></li><li><a href="https://zmngw.github.io/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul><script async src="https://fastly.jsdelivr.net/gh/usteinfo/usteinfo.github.io@master/assets/vendor/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="mobile-hidden" style="margin-top:8px"> <span id="busuanzi_container_site_pv" style="display:none"> 本站访问量<span id="busuanzi_value_site_pv"></span>次 </span> <span id="busuanzi_container_site_uv" style="display:none"> / 本站访客数<span id="busuanzi_value_site_uv"></span>人 </span> <span id="busuanzi_container_page_pv" style="display:none"> / 本页访问量<span id="busuanzi_value_page_pv"></span>次 / 统计始于2023-09-02 </span></div></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://fastly.jsdelivr.net/gh/usteinfo/usteinfo.github.io@master/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script></body></html>
